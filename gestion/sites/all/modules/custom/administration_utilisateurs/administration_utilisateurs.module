<?php

require_once 'administration_utilisateurs_mail_langs.inc';

function _access_callback_valider() {
  if (shared_user_access('GES_MOD_UTI')) {
    return true;
  } else {
    global $user;

    $id_drupal_user = shared_get_drupal_user_id($user->uid);
    if (arg(2) == $id_drupal_user) {
      return true;
    } else {
      return false;
    }

  }
}

/**
 * Implements hook_menu().
 *
 * Cette fonction rajoute un menu d'accès pour la création de compte des entreprises.
 * Return: Drupal menu items
 */
function administration_utilisateurs_menu() {
  $items = array();

  // Gestion des utilisateurs
  $items['opcaim-admin/utilisateurs'] = array(
      'title' => 'Gestion des utilisateurs',
      'page callback' => 'administration_utilisateurs_liste_page',
      'access arguments' => array('GES_LIS_UTI'),
      'file' => '/liste/administration_utilisateurs_liste_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  // Gestion des utilisateurs
  $items['opcaim-admin/utilisateurs/creation'] = array(
      'title' => 'Ajouter un utilisateur',
      'page callback' => 'administration_utilisateurs_creation_page',
      'access arguments' => array('GES_AJO_UTI'),
      'page arguments' => array(3),
      'file' => '/creation/administration_utilisateurs_creation_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  // Gestion des utilisateurs
  $items['opcaim-admin/utilisateurs/valider'] = array(
      'title' => 'Valider un utilisateur',
      'page callback' => 'administration_utilisateurs_validation_page',
      'access arguments' => array('GES_VAL_UTI'),
      'page arguments' => array(3),
      'file' => '/validation/administration_utilisateurs_validation_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  // Modifier un utilisateur
  $items['opcaim-admin/utilisateurs/modifier'] = array(
      'title' => 'Modifier un utilisateur',
      'page callback' => 'administration_utilisateurs_modification_page',
      'access arguments' => array('GES_MOD_UTI'),
      'page arguments' => array(3),
      'file' => '/modification/administration_utilisateurs_modification_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  // Supprimer un utilisateur
  $items['opcaim-admin/utilisateurs/supprimer'] = array(
      'title' => 'Supprimer un utilisateur',
      'page callback' => 'administration_utilisateurs_suppression_callback',
      'access arguments' => array('GES_SUP_UTI'),
      'page arguments' => array(3),
      'file' => '/suppression/administration_utilisateurs_suppression_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  // Bloquer un utilisateur
  $items['opcaim-admin/utilisateurs/bloquer/%'] = array(
      'title' => 'Supprimer un utilisateur',
      'page callback' => 'administration_utilisateurs_bloquer_callback',
      'access arguments' => array('GES_SUP_UTI'),
      'page arguments' => array(3),
      'file' => '/suppression/administration_utilisateurs_suppression_controller.inc',
      'type' => MENU_CALLBACK,
  );

  // Gestion des utilisateurs
  $items['mon-compte'] = array(
      'title' => 'Mon compte',
      'page callback' => 'administration_utilisateurs_mon_compte_page',
      'access arguments' => array('access content'),
      'file' => '/mon_compte/administration_utilisateurs_mon_compte_controller.inc',
      'type' => MENU_NORMAL_ITEM,
  );

  _administration_utilisateurs_menu_ajax($items);

  return $items;
}

/**
 * Fonction qui gère les url ajax pour les modifications du périmètre établissements
 *
 * @param array $items
 */
function _administration_utilisateurs_menu_ajax(&$items) {
  $items['opcaim-admin/utilisateurs/%/etablissement/%/valider/%'] = array(
      'page callback' => 'administration_utilisateurs_ajax_valider',
      'access arguments' => array('GES_MOD_UTI'),
      'page arguments' => array(2, 4, 6),
      'file' => '/ajax/administration_utilisateurs_ajax_controller.inc',
      'type' => MENU_CALLBACK,
  );

  $items['opcaim-admin/utilisateurs/%/etablissement/%/refuser/%'] = array(
      'page callback' => 'administration_utilisateurs_ajax_refuser',
      'access arguments' => array('GES_MOD_UTI'),
      'page arguments' => array(2, 4, 6),
      'file' => '/ajax/administration_utilisateurs_ajax_controller.inc',
      'type' => MENU_CALLBACK,
  );

  $items['opcaim-admin/utilisateurs/%/etablissement/attacher/%/%'] = array(
      'page callback' => 'administration_utilisateurs_ajax_attacher',
//       'access arguments' => array('GES_MOD_UTI'),
      'access callback' => '_access_callback_valider',
      'page arguments' => array(2, 5, 6),
      'file' => '/ajax/administration_utilisateurs_ajax_controller.inc',
      'type' => MENU_CALLBACK,
  );

  $items['opcaim-admin/utilisateurs/%/etablissement/%/retirer/%'] = array(
      'page callback' => 'administration_utilisateurs_ajax_retirer',
      'access callback' => '_access_callback_valider',
      'page arguments' => array(2, 4, 6),
      'file' => '/ajax/administration_utilisateurs_ajax_controller.inc',
      'type' => MENU_CALLBACK,
  );

}

/**
 * hook theme()
 *
 * Fonction qui permet de définir le template
 *
 * @param unknown $existing
 * @param unknown $type
 * @param unknown $theme
 * @param unknown $path
 * @return multitype:multitype:string
 */
function administration_utilisateurs_theme($existing, $type, $theme, $path) {
  $theme_array = array(
      // Template général pour afficher la liste des utilisateurs
      'administration_utilisateurs_liste_page_theme' => array(
          'template' => 'administration_utilisateurs_liste_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/liste/theme'
      ),
      // Template général pour afficher la modification d'un utilisateurs
      'administration_utilisateurs_modification_page_theme' => array(
          'template' => 'administration_utilisateurs_modification_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/modification/theme'
      ),
      // Template général pour afficher la page mon compte
      'administration_utilisateurs_mon_compte_page_theme' => array(
          'template' => 'administration_utilisateurs_mon_compte_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/mon_compte/theme'
      ),
      // Template général pour afficher la page mon compte (modifier)
      'administration_utilisateurs_mon_compte_modifier_page_theme' => array(
          'template' => 'administration_utilisateurs_mon_compte_modifier_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/mon_compte/theme'
      ),

      // Template général pour afficher la modification d'un utilisateurs
      'administration_utilisateurs_validation_page_theme' => array(
          'template' => 'administration_utilisateurs_validation_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/validation/theme'
      ),
      // Template général pour afficher la modification d'un utilisateurs
      'administration_utilisateurs_creation_page_theme' => array(
          'template' => 'administration_utilisateurs_creation_page',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/creation/theme'
      ),

      // Template pour la partie info perso de la modification d'un utilisateurs
      'administration_utilisateurs_common_page_info_perso_theme' => array(
          'template' => '_administration_utilisateurs_common_page_info_perso',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/common/theme'
      ),
      // Template pour la partie fonctionnalite de la modification d'un utilisateurs
      'administration_utilisateurs_common_page_fonctionnalite_theme' => array(
          'template' => '_administration_utilisateurs_common_page_fonctionnalite',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/common/theme'
      ),
      // Template pour la partie établissement de la modification d'un utilisateurs
      'administration_utilisateurs_common_page_etablissement_theme' => array(
          'template' => '_administration_utilisateurs_common_page_etablissement',
          'path' => drupal_get_path('module', 'administration_utilisateurs') .'/common/theme'
      ),
  );

  return $theme_array;
}

/**
 * administration_utilisateurs_mail
 *
 * hook mail()
 *
 * @param unknown $key
 * @param unknown $message
 * @param unknown $params
 */
function administration_utilisateurs_mail($key, &$message, $params) {
  switch ($key) {
    // Send a simple message from the refuse_account form.
    case 'refuse_account':
      $message['subject'] = t(@MAIL_SUBJECT_REFUSE_ACCOUNT);
      // Note that the message body is an array, not a string.
      $message['body'][] = htmlspecialchars(
          t(@MAIL_BODY_REFUSE_ACCOUNT, array('@name' => $params['name'])),
          ENT_COMPAT,
          'UTF-8'
      );
      break;
  }
}