<?php

/**
 *  Fichier requis par le formulaire
 * 
 * 
 */
function _dgf_demande_require_once() {
  require_once 'dgf_demande_db.inc';
  require_once 'dgf_demande_langs.inc';
  require_once 'dgf_demande_submit.inc';
  require_once 'dgf_demande_validate.inc';
}

/**
 *   Fichiers d'ajout des JS et CSS
 * 
 */
function _dgf_demande_include_js_css() {
  drupal_add_js(drupal_get_path('module', 'dgf' ) . '/inc/demande/js/dgf_demande.js' );
  drupal_add_css(drupal_get_path('module', 'dgf' ) . '/inc/demande/css/dgf_demande.css' );
}

/**
 *  Formulaire des types de demande DGF.
 * 
 *  @param: $form, &$form_state
 *  @return: $form
 * 
 */
function dgf_demande_form($form, &$form_state) {
  _dgf_demande_require_once();
  _dgf_demande_include_js_css();
  global $user;
  shared_get_referentiel_data(array('ref_nature_demande', 'ref_nature_formation'), false);
  
  // si appel depuis le dashboard
//   $default_nature = isset($_GET['nature']) ? $_GET['nature'] : null;
  $default_nature =  isset($_SESSION['demande']) ? $_SESSION['demande']['nature_demande'] : null;
  
  if (isset($_SESSION['demande'])) {
    unset($_SESSION['demande']);
  }

  $temp_dgf_form_demande = array();
  if (arg(2)) {
    $id_dgf = shared_security_access_user(2, 'DGF');
    $temp_dgf_form_demande = demande_db_get_temp_dgf_form_demande($id_dgf);
    $default_nature = $temp_dgf_form_demande ? $temp_dgf_form_demande['id_dgf_nature_demande'] : null;
  }

  $form['cerfa-step'] = array(
      '#type' => 'hidden',
      '#default_value' => '/'.drupal_get_path('theme', 'opcaim').'/images/cerfa-2.png',
  );

  $form['nature_demande'] = array(
      '#type' => 'radios',
      '#title' => t('Quelle est la nature de votre demande ?
          <span class="sublabel">(un seul choix possible)</span>' ),
      '#options' => $_SESSION['referentiel_extranet_datas']['ref_nature_demande'],
      '#default_value' => $default_nature,
  );

  $form['nature_formation'] = array(
      '#type' => 'radios',
      '#title' => t('Nature de la formation
          <span class="sublabel">(un seul choix possible)</span>'),
      '#options' => $_SESSION['referentiel_extranet_datas']['ref_nature_formation'],
      '#default_value' => $temp_dgf_form_demande ? $temp_dgf_form_demande['id_dgf_nature_formation'] : null,
  );
 
  $form['rappel_contrat_pro'] = array(
      '#type' => 'item',
      '#markup' => t(@RAPPEL_CONTRAT_PRO),
  );

  // TODO : champ entreprise
  $form['multi-etablissement'] = array(
      '#type' => 'radios',
      '#title' => t('Souhaitez-vous créer une demande multi-établissement ?'),
      '#default_value' => (1),
      '#options' => array(
          0 => t('Oui'),
          1 => t('Non' )
      )
  );
  
  $entreprises = $user->data['extranet_user']->entreprises;
  $listeEtab = array();
  foreach ($entreprises as $entreprise) {
    $listeEtab[$entreprise->id_ref_esclave_entreprise]=(t($entreprise->raison_social));
  }
  $form['liste_multi-etablissement'] = array(
      '#type' => 'select',
      '#multiple' => true,
//       '#size' => $listeEtab ? min(12, count($listeEtab)) : 0,
      '#title' => t('Sélectionner les entreprises'),
      '#options' => $listeEtab,

  );

  // TODO : champ ADEFIM

  $form['back'] = array(
      '#type' => 'button',
      '#value' => t('Annuler'),
      '#limit_validation_errors' => array(),
      '#attributes' => array('class' => array('cancel')),
  );

    $form['next'] = array(
      '#type' => 'submit',
      '#value' => t('Suivant'),
      '#validate' => array('dgf_demande_form_validate'),
      '#submit' => array('dgf_demande_form_submit'),
  );
  
  // Ajout de la modal confirm
  dgf_modal_confirm_form($form);

  return $form;
}

function dgf_modal_confirm_form(&$form) {
  $prefix = '<div id="modalquit" class="modal" tabindex="-1" role="dialog" >
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                  <div class="modal-header">
                     <button type="button" class="close modalQuit" data-dismiss="modal" >&times;</button>
                        <h4>Confirmer la demande </h4>
                  </div>
                    <div class="modal-footer">';

  $suffix = '</div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->';


  $form['modal_quit']['header'] = array(
      '#type' => 'markup',
      '#markup' => $prefix,
  );


  $form['modal_quit']['modal_quit'] = array(
      '#type' => 'submit',
      '#value' => t('Non'),
     '#validate' => array('dgf_demande_form_modal_validate'),
      '#submit' => array('dgf_demande_form_modal_submit'),
  );

  $form ['modal_quit']['modal_save'] = array(
      '#type' => 'submit',
      '#value' => t('Oui'),
      '#validate' => array('dgf_demande_form_modal_validate'),
      '#submit' => array('dgf_demande_form_modal_submit'),
      '#attributes' => array(
          'class' => array('btn btn-primary modalSave'),
      ),

  );

  $form['modal_quit']['footer'] = array(
      '#type' => 'markup',
      '#markup' => $suffix,
  );

}