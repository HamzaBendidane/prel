<?php
/**
 * Require fonction
 * @return
 */
function _validation_liste_required(){
    require_once 'common/common_db.inc';
    require_once 'common/common_form.inc';
    require_once 'common/common_validate.inc';
    require_once 'common/common_submit.inc';
    require_once 'common_langs.inc';
    require_once 'validation_liste/validation_liste_db.inc';
    require_once 'validation_liste/validation_liste_form.inc';
}

/**
 *   Add JS & CSS
 *
 */
function _validation_liste_add_js_css() {
    $path  = drupal_get_path('module', 'dgf_administration_etablissements' );
    drupal_add_js( $path . '/common/js/common.js' );
    drupal_add_css($path . '/common/css/common.css' );
    drupal_add_js( $path . '/validation_liste/js/validation_liste.js' );
    drupal_add_css($path . '/validation_liste/css/validation_liste.css' );
}

/**
 *  Appel de fonctions
 */
_validation_liste_required();
_validation_liste_add_js_css();


function compute_title($page){

    if (arg(3)) {
        $id_entreprise = arg(3);
        $infos_entreprise = shared_get_infos_entreprise($id_entreprise);
        $raisonsociale = $infos_entreprise['raison_sociale'];
    }
    $raisonsociale = '';
    $aTitle = array();
    $aTitle ['gestion_liste_organisme'] = t('Gestion des organismes de formation');
    $aTitle ['gestion_liste_entreprise'] = t('Gestion des établissements');
    $aTitle ['valider_liste_organisme'] = t('Validation des organismes de formation');
    $aTitle ['valider_liste_entreprise'] = t('Validation des établissements');

    $aTitle ['valider_organisme'] = t('Validation des organismes de formation');
    $aTitle ['valider_entreprise'] = t("Validation de l'établissement ".$raisonsociale);
    $aTitle ['modifier_entreprise'] = t("Modification de l'établissement ".$raisonsociale);
    $aTitle ['modifier_organisme'] = t('Modification des organismes de formation');
    $aTitle ['creation_entreprise'] = t("Création des établissements");
    return $aTitle[$page];

}

function compute_sub_title($page){

    $aTitle = array();
    $aTitle ['gestion_liste_organisme'] = t('Rechercher des organismes de formation');
    $aTitle ['gestion_liste_entreprise'] = t('Rechercher des établissements');
    $aTitle ['valider_liste_organisme'] = t('Rechercher des organismes de formation');
    $aTitle ['valider_liste_entreprise'] = t('Rechercher des établissements');
    $aTitle ['valider_organisme'] = t('Rechercher des organismes de formation');
    $aTitle ['valider_entreprise'] = t('Rechercher des établissements');

    return $aTitle[$page];
}

function compute_add_button ($page){
    if (shared_user_access('GES_AJO_ETA') && !is_validation_page($page)) {
        return  l('Ajouter', compute_action($page,'add'), array(
            'attributes' => array('class' => 'edit-add-button btn btn-default')
        ));
    }else return "<br>";
}

function is_validation_page($page){
    return in_array($page,array("valider_liste_organisme",'valider_liste_entreprise'));
}

function compute_action($page,$action){

    $aUrl = array();

    $aUrl['gestion_liste_entreprise']['add'] = '/gestion/etablissement/creer/' ;
    $aUrl['gestion_liste_entreprise']['delete'] ='/gestion/etablissement/supprimer/' ;
    $aUrl['gestion_liste_entreprise']['update'] ='/gestion/etablissement/modifier/' ;

    $aUrl['gestion_liste_organisme']['add'] = '/gestion/organisme/creer/' ;
    $aUrl['gestion_liste_organisme']['delete'] ='/gestion/organisme/supprimer/' ;
    $aUrl['gestion_liste_organisme']['update'] ='/gestion/organisme/modifier/' ;

    $aUrl['valider_liste_entreprise']['show'] = '/gestion/etablissement/valider/' ;
    $aUrl['valider_liste_organisme']['show'] = '/gestion/organisme/valider/' ;


    return  $aUrl[$page][$action];
}

function validation_liste_table__view($page){

    $variables =  array(
        'form'=> drupal_get_form('dgf_administration_etablissements_listes_form'),
        'page'=> $page,
    );

    $output = theme('validation_liste', $variables);

    return $output;
}

function common_admin_view($page){

    $variables =  array(
        'form'=> drupal_get_form('common_form'),
        'page'=> $page,
    );

    $output = theme('gestion', $variables);

    return $output;

}

function display_validation_liste_results_data($page){
    print validation_liste_results_data($page);
}

function get_stored_date(){
    if (isset ($_SESSION['dgf_administration_etablissements']))
        return $_SESSION['dgf_administration_etablissements'];
    else return array();
}

/**
 *  Tableau des résultats concernant les entreprises
 *
 */
function validation_liste_results_data($page) {

    if (is_validation_page($page)){

        $header =  array('Siret','Modification','Raison sociale','Téléphone','Responsable','Action');

    }else{

        $header =  array('Siret','Raison sociale','Téléphone','Responsable','Action');

    }

  if(isset($_POST['sort']) && isset($_POST['order'])) {
    if($_POST['sort'] == 'asc')
      $sort = 'ASC';
    else
      $sort = 'DESC';
    switch($_POST['order']) {
    	case 'SIRET':
    	  $order = 'siret';
    	  break;
    	case 'Raison sociale':
    	  $order = 'raison_sociale';
    	  break;
    	default:
    	  $order = 'siret';
    }
  }
  else {
    $sort  = 'ASC';
    $order = 'raison_sociale';
  }

    $data = get_stored_date();

    $siret = isset($data['siret']) ? $data['siret'] : '';
    $corporateName = isset($data['raison_sociale']) ? $data['raison_sociale'] : '';
    $responsibleName = isset($data['nom_contact']) ? $data['nom_contact'] : '';

    $data = liste_entreprises($order, $sort, $siret, $corporateName, $responsibleName, is_validation_page($page));
    $rows = display_table_rows($data,$page);

    print theme('table',  array(
        'header' => $header,
        'rows' => $rows,
        'empty' => is_validation_page($page)? @MSG_INF_GES_ETA02 : @MSG_INF_GES_ETA01,
        'sticky' => false,
    ));
    return theme('pager');
}

/**
 *
 *
 */
function suppression_callback(){
    global $user;
    $drupal_cms_user = $user->uid; // Utilisteur connecté.

    $id_entreprise = arg(3);

    shared_security_access_user(3,'ETAB');

    $infos_entreprise = shared_get_infos_entreprise($id_entreprise);

    $data_contact = shared_get_infos_contact($id_entreprise, false);

    $id_contact = $data_contact['id'];

    supprimer_etablissement($drupal_cms_user,$id_entreprise,$id_contact,$infos_entreprise['a_id']);

    if (has_role_entreprise()) drupal_set_message(sprintf(t(@MSG_CONF_GES_ETA31),'établissement',$infos_entreprise['raison_sociale']));
    if (has_role_adefim()) drupal_set_message(sprintf(t(@MSG_CONF_GES_ETA32),'établissement',$infos_entreprise['raison_sociale']));

    /*
     * creation de la notification_event
     */
    $data = array (
            'id_entreprise' => rtrim ( $id_entreprise ),
            'callback_param' => array(
                    'id_entreprises' => array(rtrim ( $id_entreprise ))
            )

    );

    if (user_has_role(5)) {
        // Si ADMIN Entreprise

        //Création des notification_event
        create_notification_event('GST_SUP_ETB_VAL', $data);
    }

    drupal_goto($_SERVER['HTTP_REFERER']);
}

function display_table_rows($results,$page) {

    $rows = array();
    foreach ($results as $key => $items) {

        $aAction = array();
        if (!is_validation_page($page)) {
            if (shared_user_access('GES_SUP_ETA')) {
                $aAction[] = l(
                    '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>',
                    compute_action($page,'update') . $items->e_id,
                    array(
                        'html' => true,
                        'attributes' => array('class' => array('action'))
                    )
                );
            }

            if (user_access('GES_SUP_ETA')) {
                $aAction[] = l(
                    '<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>',
                    compute_action($page,'delete') .trim($items->e_id),
                    array(
                        'html' => true,
                        'attributes' => array(
                            'class' => array('action delete'),
                            'data-id' => $items->id,
                            'data-nom' => $items->raison_sociale
                        )
                    )
                );
            }
        }else {
            if (shared_user_access('GES_LIS_ETA')) {
                $aAction[] = l(
                    '<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>',
                    compute_action($page,'show')  . trim($items->e_id),
                    array(
                        'html' => true,
                        'attributes' => array('class' => array('action'))
                    )
                );
            }
        }
        $action_html = '<div class="center">' . implode(" ",$aAction). '</div>';

        $aRow = array();
        $aRow ['siret'] = $items->siret;

        if (is_validation_page($page)) $aRow ['modication'] = "Modification";

        $aRow ['raison_sociale'] = $items->raison_sociale;
        $aRow ['telephone'] = trim($items->telephone_principal) != 'NULL' ? $items->telephone_principal : '';
        $aRow ['contact'] =  trim($items->prenom). ' ' . trim($items->nom) . ' <br/> ' . trim($items->email);
        $aRow ['action'] = $action_html;

        $rows[] = $aRow ;
    }
    return $rows;

}