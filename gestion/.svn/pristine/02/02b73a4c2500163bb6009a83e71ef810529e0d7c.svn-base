<?php

function _dgf_organisme_formation_require_once_files() {
  require_once 'organisme_formation_langs.inc';
  require_once 'organisme_formation_submit.inc';
  require_once 'organisme_formation_validate.inc';
  require_once 'organisme_formation_db.inc';
  require_once 'organisme_formation_auto_complete.inc';
}

function _dgf_organisme_formation_include_js_css() {
  drupal_add_js(drupal_get_path('module', 'dgf' ) . '/inc/organisme_formation/js/organisme_formation.js' );
  drupal_add_css(drupal_get_path('module', 'dgf' ) . '/inc/organisme_formation/css/organisme_formation.css' );
}

function dgf_organisme_formation_form($form, &$form_state) {
  _dgf_organisme_formation_require_once_files();
  _dgf_organisme_formation_include_js_css();

  $fonctions = organisme_formation_db_get_function_contact();
  $civilites = shared_db_get_title();
  // On récupère les informations précédemment saisies
  $temp_dgf_form_organisme_formation = array();
  $organisme_formation = array();
  $contact_organisme_formation = array();

  // s'il est rempli, on récupère les informations de la bdd
  $id_dgf = shared_security_access_user(3, 'DGF');
  save_step_url($id_dgf,5);
  $temp_dgf_form_organisme_formation = organisme_formation_db_get_temp_dgf_form_organisme_formation($id_dgf);
  $organisme_formation = organisme_formation_db_get_v_organisme_formation(
      $temp_dgf_form_organisme_formation['id_ref_esclave_organisme_formation']);
  $adresse_organisme_formation = organisme_formation_db_get_v_adresse_organisme_formation(
      $temp_dgf_form_organisme_formation['id_ref_esclave_organisme_formation']);
  $contact_organisme_formation = organisme_formation_db_get_v_contact_organisme_formation(
      $temp_dgf_form_organisme_formation['id_ref_esclave_contacts_organisme_formation']);

  $form['cerfa-step'] = array(
      '#type' => 'hidden',
      '#default_value' => '/'.drupal_get_path('theme', 'opcaim').'/images/cerfa-5.png',
  );

  $form['id_dgf'] = array(
      '#type' => 'hidden',
      '#default_value' => $id_dgf,
  );

  if ($temp_dgf_form_organisme_formation) {
    $default_value_id_dgf_organisme_formation = trim($temp_dgf_form_organisme_formation['id_ref_esclave_organisme_formation']);
  } else if (isset($form_state['input']['siret_number'])) {
    $default_value_id_dgf_organisme_formation = trim(get_id_if_siret_already_exist($form_state['input']['siret_number']));
    $form_state['input']['id_dgf_organisme_formation'] = $default_value_id_dgf_organisme_formation;
  } else {
    $default_value_id_dgf_organisme_formation = null;
  }
  $form['id_dgf_organisme_formation'] = array(
      '#type' => 'hidden',
      '#value' => $default_value_id_dgf_organisme_formation,
      '#title' => t('Id demande' ),
  );

  $form['title_markup'] = array(
      '#type' => 'container',
      '#title' => t('Rechercher un organisme de formation')
  );

  $form['title_markup']['siret_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Numéro de SIRET'),
      '#default_value' => $organisme_formation ? shared_isset_trim(@$organisme_formation['siret']) : null,
      '#element_validate' => array('element_shared_not_empty_validate'),
      '#attributes' =>array('placeholder' => t('Min. 3 chiffres')),
      '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
        <span class="spinner">&nbsp;</span>',
  );

  $form['title_markup']['activity_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Numéro de déclaration d’activité'),
      '#attributes' =>array('placeholder' => t('Min. 3 chiffres')),
      '#element_validate' => array('element_shared_not_empty_validate'),
      '#default_value' => $organisme_formation ? shared_isset_trim(@$organisme_formation['numero_de_declaration_existence']) : null,
      '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
        <span class="spinner">&nbsp;</span>',
  );

  $form['title_markup']['corporate_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Raison sociale'),
      '#attributes' =>array('placeholder' => t('Min. 3 lettres')),
      '#element_validate' => array('element_shared_not_empty_validate'),
      '#default_value' => $organisme_formation ? shared_isset_trim(@$organisme_formation['raison_sociale']) : null,
      '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
        <span class="spinner">&nbsp;</span>',
  );

  $form['id_ref_organisme_formation'] = array(
      '#type' => 'hidden',
      '#default_value' => $temp_dgf_form_organisme_formation ?
        $temp_dgf_form_organisme_formation['id_ref_esclave_organisme_formation'] : null,
      '#title' => t('Id demande' ),
      '#attributes' => array("id" => "id-ref-formation")
  );

//   // OF possède un compte
//   $form['extranet_count'] = array(
//       '#type' => 'checkbox',
//       '#title' => t('OF possède un compte extranet.'),
//       '#attributes' =>array(
//           'checked' => t('checked'),
//           'disabled' => true,
//       ),
//   );

  _dgf_organisme_formation_info_generale_form($form);

  _dgf_organisme_formation_contact_form($form, $temp_dgf_form_organisme_formation, $organisme_formation, $form_state,
    $fonctions, $civilites);

  _dgf_organisme_formation_new_contact_form($form, null, $fonctions, $civilites);

  _dgf_organisme_formation_cout_form($form, $temp_dgf_form_organisme_formation);

  $form['fielset_direct_payment'] = array(
      '#type' => 'fieldset',
      '#title' => '',
  );

  $form['fielset_direct_payment']['direct_payment'] = array(
      '#type' => 'radios',
      '#title' => t('Le tuteur : ' ),
      '#options' => array(
          1 => t('Souhaite que l\'OPCAIM règle directement l’organisme de formation.' ),
          0 => t('Ne souhaite pas que l\'OPCAIM règle directement l’organisme de formation, demande le remboursement.' )
      ),
      '#default_value' => $temp_dgf_form_organisme_formation ? $temp_dgf_form_organisme_formation['paiement_direct'] : null,
      '#title' => t(''),
  );

  // Début Modal Quitter
  $form['clearfix'] = array(
      '#type' => 'markup',
      '#markup' => '<div class="clearfix"></div>',
  );

  $form['padding_fin'] = array(
      '#type' => 'markup',
      '#markup' => '</div>',
  );
  // Ajout des boutons d'actions
  $validatorsBoutonNext = array(
      'dgf_organisme_formation_standard_validate',
      'dgf_organisme_formation_specific_validate',
  );
  $submitsBoutonNext = array('dgf_organisme_formation_form_submit');
  dgf_boutons_action_form($form, $validatorsBoutonNext, $submitsBoutonNext);

  // Ajout de la modal quitter
  $validatorsSave = array (
//         'dgf_organisme_formation_standard_validate',
//         'dgf_organisme_formation_specific_validate'
  );
  $submitsSave = array('dgf_organisme_formation_form_submit');
  dgf_modal_quit_form($form,  $validatorsSave, $submitsSave);

  return $form;
}

function _dgf_organisme_formation_info_generale_form(&$form) {
  $form['info_generale'] = array(
      '#type' => 'container',
  );

  // TODO : à faire dans le cas où il n'y a rien en BDD et qu'on poste notre form avec un OF
  $form['info_generale']['street_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Adresse'),
  );

  $form['info_generale']['address_complement'] = array(
      '#type' => 'textfield',
      '#title' => t('Complement rue'),
  );

  $form['info_generale']['address_complement_2'] = array(
        '#type' => 'textfield',
        '#title' => t('Complement rue 2'),
    );

  $form['info_generale']['zip_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Code postal / Ville'),
      '#attributes' => array(
          'placeholder' => t('CP'),
          'class' => array('coller-serrer-1', 'cp-lenght')
      ),
  );

  $form['info_generale']['city'] = array(
      '#type' => 'textfield',
      '#attributes' => array(
          'placeholder' => t('Ville'),
          'class' => array('coller-serrer-2')
      ),
  );

  $form['info_generale']['country'] = array(
      '#type' => 'textfield',
      '#default_value' => 'France',
  );

  $form['info_generale']['phone_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
      '#attributes' =>array('class' => array('telephone-lenght'), 'placeholder' => t('Ex: 0142154798')),
  );

  $form['info_generale']['email'] = array(
      '#type' => 'textfield',
      '#title' => t('Courriel'),
  );

  $form['info_generale']['tva_bool'] = array(
      '#type' => 'checkbox',
      '#title' => t('Assujetti à la TVA'),
  );

  $form['info_generale']['tva_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Numéro de TVA'),
  );
}

function _dgf_organisme_formation_contact_form(&$form, $temp_dgf_form_organisme_formation, $organisme_formation, $form_state, $fonctions, $civilites) {
  $form['contact_markup'] = array(
      '#type' => 'container',
      '#title' => t('Personne à contacter')
  );

  // récupérer les contacts si on est en modif ou une erreur dans le form
  if (isset($form_state['input']['siret_number'])) {
    $contact = organisme_formation_db_get_contact_select($form_state['input']['siret_number']);
  } else if ($organisme_formation) {
    $contact = organisme_formation_db_get_contact_select_from_id(trim($organisme_formation['id']));
  } else {
    $contact = array();
  }

//   array_unshift($contact, @$_SESSION['contact']);

  array_unshift($contact,"Veuillez choisir dans la liste.");

  $form['contact_markup']['select_contact'] = array(
      '#type' => 'select',
      '#title' => t('Contact'),
      '#default_value' => $temp_dgf_form_organisme_formation ? trim($temp_dgf_form_organisme_formation['id_ref_esclave_contacts_organisme_formation']) : null,
      '#options' => $contact,
  );

//   $popup_contact =  @$_SESSION['contact'];

//   $form['contact_markup']['popup_contact'] = array(
//       '#type' => 'item',
//       '#markup' => "<span class='contact_infos'>".$popup_contact."</span>",
//   );

  $form['contact_markup']['add'] = array(
      '#type' => 'button',
      '#value' => t('Ajouter' ),
      '#attributes' => array(
          'class' => array('btn add-button'),
          'type' => array('button'),
      ),
  );

  $form['contact_complete'] = array(
      '#type' => 'container',
      '#title' => t('Personne à contacter'),
  );

  $form['contact_complete']['complete_contact_fonction'] = array(
      '#type' => 'select',
      '#title' => t('Fonction'),
      '#options' => $fonctions,
  );

  $form['contact_complete']['complete_contact_mail'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
  );

  $form['contact_modal'] = array(
      '#type' => 'container',
      '#title' => t(''),
  );

  $form['contact_modal']['modal_contact_title'] = array(
      '#type' => 'radios',
      '#title' => t('Civilité'),
      '#options' => $civilites,
      '#prefix' => '<div class="required">',
      '#suffix' => '</div>',
  );

  $form['contact_modal']['modal_contact_lastname'] = array(
      '#type' => 'textfield',
      '#title' => t('Nom'),
  );

  $form['contact_modal']['modal_contact_firstname'] = array(
      '#type' => 'textfield',
      '#title' => t('Prénom'),
  );

  $form['contact_modal']['modal_contact_fonction'] = array(
      '#type' => 'select',
      '#title' => t('Fonction'),
      '#options' => $fonctions,
  );

  $form['contact_modal']['modal_contact_mail'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
  );

  $form['contact_modal']['modal_contact_phone'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
      '#attributes' =>array('class' => array('telephone-lenght'), 'placeholder' => t('Ex: 0142154798')),
  );

}

function _dgf_organisme_formation_new_contact_form(&$form, $data, $fonctions, $civilites) {

  $form['new_contact'] = array(
      '#type' => 'fieldset',
      '#title' => t('Personne à contacter'),
      '#attributes' => array('style' => 'display: none;'),
  );

  $form['new_contact']['new_contact_title'] = array(
      '#type' => 'radios',
      '#title' => t('Civilité'),
      '#options' => $civilites,
  );

  $form['new_contact']['new_contact_lastname'] = array(
      '#type' => 'textfield',
      '#title' => t('Nom'),
  );

  $form['new_contact']['new_contact_firstname'] = array(
      '#type' => 'textfield',
      '#title' => t('Prénom'),
  );

  $form['new_contact']['new_contact_fonction'] = array(
      '#type' => 'select',
      '#title' => t('Fonction'),
      '#options' => $fonctions,
  );

  $form['new_contact']['new_contact_phone'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
      '#attributes' =>array('class' => array('telephone-lenght'), 'placeholder' => t('Ex: 0142154798')),
  );

  $form['new_contact']['new_contact_mail'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
  );
}

function _dgf_organisme_formation_cout_form(&$form, $temp_dgf_form_organisme_formation) {
  $form['cost'] = array(
      '#type' => 'fieldset',
      '#title' => t('Coûts / dépenses'),
  );

  $form['cost']['pedagogical_cost'] = array(
      '#type' => 'textfield',
      '#title' => t('Coût pédagogique €HT'),
      '#default_value' => $temp_dgf_form_organisme_formation ? $temp_dgf_form_organisme_formation['cout_pedagogique'] : NULL,
      '#element_validate' => array('element_shared_decimal_validate'),
      '#attributes' => array('class' => array('price-lenght')),
  );

  $form['cost']['eval_pre_formative'] = array(
      '#type' => 'textfield',
      '#title' => t('Evaluation pré-formative'),
      '#default_value' => $temp_dgf_form_organisme_formation ? $temp_dgf_form_organisme_formation['evaluation_preformative'] : NULL,
      '#attributes' => array('class' => array('price-lenght')),
      '#element_validate' => array('element_shared_decimal_validate'),
  );

//   $form['cost']['clearfix'] = array(
//       '#type' => 'markup',
//       '#markup' => '<div class="clearfix"></div>',
//   );

  $form['cost']['certification_passing'] = array(
      '#type' => 'textfield',
      '#title' => t('Passage de la certification'),
      '#default_value' => $temp_dgf_form_organisme_formation ? $temp_dgf_form_organisme_formation['passage_certification'] : NULL,
      '#element_validate' => array('element_shared_decimal_validate'),
      '#attributes' => array('class' => array('price-lenght')),
  );
}