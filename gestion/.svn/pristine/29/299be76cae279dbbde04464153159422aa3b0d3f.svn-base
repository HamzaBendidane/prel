<?php
/**
 *  Création d'un établissement
 *  Envoie des données
 *  Hook_form()
 *
 *  @param: $form
 *  @param: $form_state
 *
 *
 */
function common_form($form, &$form_state) {

    global $user;

    $id_entreprise = arg(3);

    if (arg(3)) shared_security_access_user(3,'ETAB');

    // Raison sociale et idadresse
    $infos_entreprise = shared_get_infos_entreprise($id_entreprise);

    $raison_sociale = shared_isset_trim($infos_entreprise['raison_sociale']);
    $id_adresse = shared_isset_trim($infos_entreprise['a_id']);


    $form['modification']['id_adresse'] = array(
        '#type' => 'hidden',
        '#default_value' => $id_adresse,
    );
    $idadefim = null;
    $data_contact = array();
    if($id_entreprise) {

        if (!$infos_entreprise) redirect_no_access();

        $data_entreprise = shared_get_infos_entreprise($id_entreprise);
        $data_contact = shared_get_infos_contact($id_entreprise);

        $form['modification']['id_contact'] = array(
            '#type' => 'hidden',
            '#default_value' => isset($data_contact['id_contact_entreprise']) ? trim($data_contact['id_contact_entreprise']) : null,
        );

        $siret = shared_isset_trim($data_entreprise['siret']);
        $raison_sociale = shared_isset_trim($data_entreprise['raison_sociale']);
        $tel = trim($data_entreprise['telephone_principal']) != 'NULL' ? shared_isset_trim($data_entreprise['telephone_principal']) : '';
//         $code_nafs = shared_isset_trim($data_entreprise['vna_code']);
//         $libelle_nafs = shared_isset_trim($data_entreprise['vna_libelle']);
        $id_filiere = shared_isset_trim($data_entreprise['id_secteur_activite']);
        $code_filiere = shared_isset_trim($data_entreprise['secteurs_activite']['code']);
        $libelle_filiere = shared_isset_trim($data_entreprise['secteurs_activite']['libelle']);
        $id_nace = shared_isset_trim($data_entreprise['id_nace']);
        $libelle_nace = shared_isset_trim($data_entreprise['naces']['libelle']);
        $code_nace = shared_isset_trim($data_entreprise['naces']['code']);
        $rue = shared_isset_trim($data_entreprise['rue']);
        $complt_rue = shared_isset_trim($data_entreprise['complement_de_rue']);
        $complt_rue2 = shared_isset_trim($data_entreprise['complement_de_rue_2']);
        $cp = shared_isset_trim($data_entreprise['code_postal']);
        $ville = shared_isset_trim($data_entreprise['ville']);
        $idadefim = shared_isset_trim($data_entreprise['id_adefim']);

        // Ancien ID de gestion
        $form['id_adefim_ancien'] = array(
            '#type' => 'hidden',
            '#default_value' => $idadefim
        );

    }
    $form['old_siret'] = array(
        '#type' => 'hidden',
        '#default_value' => @$siret,
    );
    /*
    $etablissements = array('etablissement' => 'établissement');
    $form['type_etablissement'] = array(
        '#type' => 'select',
        '#title' => t('Type établissement'),
        '#options' => $etablissements,
        '#default_value' => $etablissements['etablissement'],
    );

    $adefims = shared_get_adefim();
    $form['adefim_gestion'] = array(
        '#type' => 'select',
        '#title' => t('ADEFIM de gestion'),
        '#options' => $adefims,
        "#default_value" => $idadefim ? $idadefim : shared_isset_trim(@$user->data['extranet_user']->user_adefim->id_adefim)
    );
    */

    $form['mod_type'] = array(
        '#type' => 'hidden',
        '#default_value' => '',
    );

    $form['resp']['title'] = array(
        '#type' => 'radios',
        '#title' => t('Civilité'),
        '#options' => shared_db_get_title(false),
        '#attributes' => array('required'),
        '#default_value' => shared_isset_trim(@$data_contact['id_civilite']),
        '#attributes' => array('class' => array('inline-radios')),
    );
    $form['resp']['lastname'] = array(
        '#type' => 'textfield',
        '#title' => t('Nom'),
        '#default_value' => shared_isset_trim(@$data_contact['nom']),
    );
    $form['resp']['firstname'] = array(
        '#type' => 'textfield',
        '#title' => t('Prénom'),
        '#default_value' => shared_isset_trim(@$data_contact['prenom']),

    );
    $form['resp']['function'] = array(
        '#type' => 'select',
        '#title' => t('Fonction'),
        '#options' => shared_db_get_fonction(true),
        '#default_value' => shared_isset_trim(@$data_contact['id_fonction']),

    );
    $form['resp']['email'] = array(
        '#type' => 'textfield',
        '#title' => t('Email'),
        '#default_value' => shared_isset_trim(@$data_contact['email']),
    );
    $form['resp']['confirm_email'] = array(
        '#type' => 'textfield',
        '#title' => t('Confirmation courriel'),
        '#default_value' => shared_isset_trim(@$data_contact['email']),
    );


    $form['back'] = array(
        '#type' => 'submit',
        '#value' => t('Retour'),
        '#submit' => array('creation_form_cancel_submit'),
        '#validate' => array('creation_form_skip'),
    );
    if (arg(2) == 'valider'){

        $form['mod_type'] = array(
            '#type' => 'hidden',
            '#default_value' => 'valider',
        );

        $form['refuser-creation'] = array(
            '#type' => 'submit',
            '#value' => t('Refuser création'),
            '#submit' => array('validation_form_cancel_submit'),
            '#validate' => array('validation_form_skip'),
        );
        $form['submit'] = array(
            '#type' => 'submit',
            '#value' => t('Valider la création'),
            '#submit' => array('modification_form_submit'),
            '#validate' => array('creation_form_validate'),
        );
    }
    else if ($id_entreprise){

        $form['submit'] = array(
            '#type' => 'submit',
            '#value' => t('Modifier'),
            '#submit' => array('modification_form_submit'),
            '#validate' => array('creation_form_validate'),
        );
    }else{
        $form['submit'] = array(
            '#type' => 'submit',
            '#value' => t('Ajouter'),
            '#submit' => array('creation_form_submit'),
            '#validate' => array('creation_form_validate'),
        );
    }


    $form['etab']['siret'] = array(
        '#type' => 'textfield',
        '#title' => t('SIRET'),
        '#default_value' => shared_isset_trim(@$siret),
        '#field_suffix' => '<span class="spinner">&nbsp;</span>',
        '#attributes' => array('class' => array('siret-lenght')),
    );
    $form['etab']['corporate_name'] = array(
        '#type' => 'textfield',
        '#title' => t('Raison sociale'),
        '#default_value' => shared_isset_trim(@$raison_sociale),
    );

    $form['etab']['street_name'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Adresse'),
        '#attributes' =>array(
            'class' => array('address-field'),
            'placeholder' => t(''),
        ),
         '#default_value' => shared_isset_trim(@$rue),
    );
    $form['etab']['adress_complement'] = array(
        '#type' => 'textfield',
        '#title' => t('Complément rue'),
        '#default_value' => shared_isset_trim(@$complt_rue),
        '#attributes' => array('class' => array('address-field')),
    );
    $form['etab']['adress_complement_2'] = array(
        '#type' => 'textfield',
        '#title' => t('Complément rue 2'),
        '#default_value' => shared_isset_trim(@$complt_rue2),
        '#attributes' => array('class' => array('address-field')),
    );
    $form['etab']['zip_code'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Code postal / Ville'),
        '#attributes' => array(
            'placeholder' => t('CP'),
            'class' => array('coller-serrer-1', 'cp-lenght', 'cp-field', 'address-field')
        ),
         '#default_value' => shared_isset_trim(@$cp),
        '#element_validate' => array('element_shared_code_postal'),
    );
    $form['etab']['city'] = array(
        '#type'     => 'textfield',
        '#title'    => t(''),
        '#attributes' => array(
            'placeholder' => t('Ville'),
            'class' => array('coller-serrer-2', 'address-field')
        ),
        '#default_value' => shared_isset_trim(@$ville),
    );
    $form['etab']['code_nace'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Code nace'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        ),
        '#default_value' => shared_isset_trim(@$code_nace),
    );

    $form['etab']['libelle_nace'] = array(
        '#type'     => 'textfield',
        '#title'    => t(''),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        ),
        '#default_value' => shared_isset_trim(@$libelle_nace),
    );

    $form['etab']['id_nace'] = array(
        '#type' => 'hidden',
        '#default_value' => shared_isset_trim(@$id_nace),
    );

    $form['etab']['code_filiere'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Secteur d\'activité principal'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        ),
        '#default_value' => shared_isset_trim(@$code_filiere),
    );
    
    $form['etab']['libelle_filiere'] = array(
        '#type'     => 'textfield',
        '#title'    => t(''),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        ),
        '#default_value' => shared_isset_trim(@$libelle_filiere),
    );

    $form['etab']['id_filiere'] = array(
        '#type'     => 'hidden',
        '#default_value' => shared_isset_trim(@$id_filiere),
    );

    $form['etab']['code_filiere2'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Secteur d\'activité secondaire'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        )
    );

    $form['etab']['libelle_filiere2'] = array(
        '#type'     => 'textfield',
        '#title'    => t('Filière 1'),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        )
    );

    $form['etab']['id_filiere2'] = array(
        '#type'     => 'hidden',
    );

    $form['etab']['phone_number'] = array(
        '#type' => 'textfield',
        '#title' => t('Téléphone'),
        '#attributes' =>array('class' => array('telephone-lenght'), 'placeholder' => t('Ex: 0142154798')),
        '#default_value' => shared_isset_trim(@$tel),
        '#element_validate' => array('element_shared_telephone'),
    );

    return $form;
}