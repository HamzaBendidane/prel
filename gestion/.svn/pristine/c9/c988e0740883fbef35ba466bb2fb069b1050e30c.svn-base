<?php

function _dgf_attestation_require_once_files() {
  require_once 'attestation_db.inc';
  require_once 'attestation_langs.inc';
  require_once 'attestation_submit.inc';
  require_once 'attestation_validate.inc';
}

function _dgf_attestation_include_js_css() {
  drupal_add_js(drupal_get_path('module', 'dgf' ) . '/inc/attestation/js/attestation.js' );
  drupal_add_css(drupal_get_path('module', 'dgf' ) . '/inc/attestation/css/attestation.css' );
}

// --------------------------------------------------
// Création du formulaire
// --------------------------------------------------
function dgf_attestation_form($form, &$form_state) {
  _dgf_attestation_require_once_files();
  _dgf_attestation_include_js_css();

  // on regarde le 3eme argument de l'url pour retrouver s'il y a des données
  $temp_dgf_form_attestation = array();
  // s'il est rempli, on récupère les informations de la bdd
  $id_dgf = shared_security_access_user(3, 'DGF');
  $dgf = attestation_db_get_dgf($id_dgf);
  $id_ref_esclave_entreprise = attestation_db_get_id_ref_esclave_entreprise($id_dgf);

  $adefims = attestation_db_get_liste_adefims($id_ref_esclave_entreprise);

//   $form['padding'] = array(
//       '#type' => 'markup',
//       '#markup' => '<div class="padding15"><div class="row">',
//   );

//   $form['center'] = array(
//       '#type' => 'markup',
//       '#markup' => '<div class="center col-md-8 col-md-offset-2">',
//   );

  $form['title']  = array(
      '#type' => 'markup',
      '#markup' => '<h1>'.t(@ATT_TITRE).'</h1>',
  );

  $form['id_dgf'] = array(
      '#type' => 'hidden',
      '#default_value' => $id_dgf,
      '#title' => t('Id demande' )
  );

  $form['modal'] = array(
      '#type' => 'hidden',
      '#default_value' => isset($_GET['modal']) ? $_GET['modal'] : null,
      '#title' => t('Modal fin de saisie')
  );

  $form['certifie'] = array(
      '#type' => 'checkbox',
      '#title' => t(@ATT_LABEL),
      '#default_value' => $dgf && $dgf['date_synthese'] ? true : false,
  );

  if (is_array($adefims)) {
    $form['id_adefim'] = array(
        '#type' => 'select',
        '#title' => t('ADEFIM'),
        '#default_value' => $dgf ? trim($dgf['id_ref_esclave_adefim']) : null,
        '#options' => $adefims,
    );
  } else {
    $form['id_adefim'] = array(
        '#type' => 'hidden',
        '#title' => t('ADEFIM'),
        '#default_value' => $adefims,
    );
  }



    $data = shared_db_select(@DB_EXTRANET, 'dgf', 'd', array('etape_demande'), array(array("id" , $id_dgf , "=")));

    $form['message'] = array(
        '#type' => 'markup',
        '#markup' => "<div class = 'message-merci'>".t(@ATT_ERR_DEM)."</div>",
    );

    if ($data && $data[0]->etape_demande){
        $current_step = $data[0]->etape_demande;
        if ($current_step == 8) {
            $form['transmettre'] = array(
                '#type' => 'submit',
                '#value' => t(@ATT_BOUTON),
                '#attributes' => array(
                    'class' => array('btn btn-primary'),
                ),
            );
            $form['message'] = array(
                '#type' => 'markup',
                '#markup' => '<div class="message-merci">'.t(@ATT_MSG_MERCI).'</div>',
            );
        }

    }




//   $form['fin_center'] = array(
//       '#type' => 'markup',
//       '#markup' => '</div>',
//   );

//   $form['clearfix'] = array(
//       '#type' => 'markup',
//       '#markup' => '<div class="clearfix"></div>',
//   );

//   $form['padding_fin'] = array(
//       '#type' => 'markup',
//       '#markup' => '</div></div>',
//   );

  _dgf_attestation_form_fin_saisie($form, $dgf, $id_ref_esclave_entreprise);

  return $form;
}

function _dgf_attestation_form_fin_saisie(&$form, $dgf, $id_ref_esclave_entreprise) {
//   // Gestion de l'afichage en modal
//   $prefix = '<div id="modal-fin-saisie" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
//             <div class="modal-dialog modal-lg">
//                 <div class="modal-content">
//                     <div class="modal-header">
//                         <h4 class="modal-title">Fin de saisie</h4>
//                     </div>';

//   $body_prefix    = '<div class="modal-body">';
//   $body_suffix    = '</div>';


//   $footer_prefix     = '<div class="modal-footer">';
//   $footer_suffix     = '</div>';
//   $suffix  =       '</div><!-- /.modal-content -->
//             </div><!-- /.modal-dialog -->
//           </div><!-- /.modal -->';

  $siret = shared_get_siret_entreprise($id_ref_esclave_entreprise);

  // TODO : Pour affichage en modal
//   $form['modalheader'] = array(
//       '#type' => 'markup',
//       '#markup' => $prefix,
//   );

//   $form ['modalbody'] = array (
//       '#type' => 'fieldset',
//       '#title' => '',
//       // TODO : Pour affichage en modal
//       '#prefix' => $body_prefix,
//       '#suffix' => $body_suffix,
//   );

  $form['messagefinsaisie'] = array(
      '#type' => 'markup',
      '#markup' => @MSG_FIN_DE_SAISIE,
  );

//   $form['modalbody']['framework'] = array(
//       '#type' => 'fieldset',
//   );

  $form['list'] = array(
      '#type' => 'markup',
      '#title' => t(''),
      '#markup' => '<p><b>Numéro demande : <span class="num_demande">'. $dgf['numero_demande'] .'</span></b></p>',
  );


  $form['siret'] = array(
      '#type' => 'markup',
      '#markup' => '<span class="num_siret">' . $siret . '</span>',
  );


  $form['voir_cerfa'] = array(
      '#type' => 'button',
      '#value' => @MSG_FIN_DE_SAISIE_BUTTON_EDIT_CERFA,
      //'#submit' => array('attestation_generate_cerfa_submit'),
      '#attributes' => array(
          'class' => array('btn btn-primary'),
      ),
//       '#prefix' => $footer_prefix,
  );

  if(isset($formation_tuteur)) {
    $form['tuteur_demande'] = array(
        '#type' => 'submit',
        '#value' => @MSG_FIN_DE_SAISIE_BUTTON_FUNDING_REQUEST,
        '#attributes' => array(
            'class' => array('btn btn-primary'),
        ),
    );
  }

  $form['nouvelle_demande'] = array(
      '#type' => 'submit',
      '#value' => @MSG_FIN_DE_SAISIE_BUTTON_NEW_REQUEST,
      '#attributes' => array(
          'class' => array('btn btn-primary'),
      ),
  );

  $form['duplicate_demande'] = array(
      '#type' => 'submit',
      '#value' => @MSG_DUPLICATE_BUTTON,
      // on place l'url du service devant être appelé ici -> utiliser par JS
      '#attributes' => array('data-url' => '/dgf/duplication/' . arg(3))
  );

  $form['accueil'] = array(
      '#type' => 'submit',
      '#value' => @MSG_FIN_DE_SAISIE_BUTTON_QUIT,
//       '#suffix' => $footer_suffix,
  );

  // Pour affichage en modal
//   $form['modal_quit']['footer'] = array(
//       '#type' => 'markup',
//       '#markup' => $suffix,
//   );
}
