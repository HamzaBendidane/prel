<?php
 
/**
 * Implementation of hook_block_info().
 */
function ecofolio_frontpage_block_info(){
  $blocks['ecofolio_frontpage_full'] = array('info'=>'Ecofolio full frontpage');
  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function ecofolio_frontpage_block_view($delta=''){
  global $base_url, $user, $node;
  $block = array();
  switch($delta){
    case 'ecofolio_frontpage_full':
      $block = ecofolio_frontpage_bloc_full();
      break;

  }
  return $block;
}




function ecofolio_frontpage_bloc_full() {
  if(drupal_is_front_page()) {
    //on recupere le dernier contenu publié de type "homepage"
    $query = db_select('node', 'n');
    $query->condition('n.type', 'homepage', '=');
    $query->condition('n.status', '1', '=');
    $query->fields('n', array('nid'));
    $query->orderBy('n.changed', 'DESC');
    $query->range(0, 1);
    $results = $query->execute();
    foreach($results as $r) $node_hp = node_load($r->nid);
    
    //on s'occupe du bloc en haut à gauche
    $left_node = node_load($node_hp->field_homepage_bhg['und'][0]['nid']);
    $link = url('node/'.$left_node->field_bloc_rem_link['und'][0]['nid']);
    $img = image_style_url("hp_top_left", $left_node->field_bloc_rem_image['und'][0]['uri']);
    $left_block = <<< END
<div class="hp_top_left">
  <a href="{$link}">
    <img src="{$img}" alt="{$left_node->field_bloc_rem_teaser['und'][0]['value']}" />
    <div class="accroche">
      <p>{$left_node->field_bloc_rem_teaser['und'][0]['value']}</p>
      <span class="more"></span>
    </div>
  </a>
</div>
END;
    
    //on s'occupe du bloc en haut au milieu
    $center_node = node_load($node_hp->field_homepage_bhm['und'][0]['nid']);
    if(isset($center_node->field_bloc_img_link_int['und'])) $link = url('node/'.$center_node->field_bloc_img_link_int['und'][0]['nid']);
    elseif(isset($center_node->field_bloc_img_link_ext['und'])) $link = $center_node->field_bloc_img_link_ext['und'][0]['url'];
    else $link = '';
    $img = image_style_url("320-402", $center_node->field_bloc_img_image['und'][0]['uri']);
    $center_block = <<< END
<div class="hp_top_center">
  <a href="{$link}">
    <img src="{$img}" />
    <div class="top">
      <h3>{$center_node->title}</h3>
      <p class="accroche">{$center_node->body['und'][0]['value']}</p>
    </div>
  </a>
</div>
END;
    
    //on s'occupe du bloc en haut à droite
    $right_node = node_load($node_hp->field_homepage_bhd['und'][0]['nid']);
    if(isset($right_node->field_bloc_dossier_link_int['und'])) $link = url('node/'.$right_node->field_bloc_dossier_link_int['und'][0]['nid']);
    elseif(isset($right_node->field_bloc_dossier_link_ext['und'])) $link = $right_node->field_bloc_dossier_link_ext['und'][0]['url'];
    else $link = '';
    $img = image_style_url("288-310", $right_node->field_bloc_dossier_image['und'][0]['uri']);
    $img = image_style_url("288-310", $right_node->field_bloc_dossier_image['und'][0]['uri']);
    $right_block = <<< END
<div class="hp_top_right">
<a href="{$link}">
  <div class="top">
    <h3>{$right_node->field_bloc_dossier_title['und'][0]['value']}</h3>
    <h2>{$right_node->field_bloc_dossier_subtitle['und'][0]['value']}</h2>
    <p class="accroche">{$right_node->field_bloc_dossier_teaser['und'][0]['value']}</p>
  </div>
  <img src="{$img}" />
  <div class="encart"><div class="decouvrir"><span>Découvrir</span></div></div>
  </a>
</div>
END;
    
    //partie lsv
    $lsv_node = node_load($node_hp->field_homepage_lsv['und'][0]['nid']);
    $tweet = urlencode($lsv_node->field_bloc_lsv_quote['und'][0]['value']);
    $lsv_block = <<< END
  <h3>{$lsv_node->field_bloc_lsv_label['und'][0]['value']}</h3>
  <h2>{$lsv_node->field_bloc_lsv_quote['und'][0]['value']}</h2>
  <a href="https://www.facebook.com/sharer/sharer.php?app_id=309437425817038&sdk=joey&u=http%3A%2F%2Fwww.ecofolio.fr%2F&display=popup&ref=plugin" class="share facebook" target="_blank"><span class="text">Partager</span><span class="ico"></span></a>
  <a href="https://twitter.com/intent/tweet?hashtags=ecofolio%2C&original_referer=http%3A%2F%2Fwww.ecofolio.fr%2F&related=ecofolio&share_with_retweet=never&text={$tweet}&tw_p=tweetbutton" class="share twitter" target="_blank"><span class="text">Tweeter</span><span class="ico"></span></a>
END;
    
    //partie bottom left
    $bleft_node = node_load($node_hp->field_homepage_bbg['und'][0]['nid']);
    $link = url('node/'.$bleft_node->field_bloc_rem_link['und'][0]['nid']);
    $img = image_style_url("hp_top_left", $bleft_node->field_bloc_rem_image['und'][0]['uri']);
    //print_r($bleft_node);
    $terms = taxonomy_term_load_multiple(array($bleft_node->field_bloc_rem_univers['und'][0]['tid']));
    foreach($terms as $term) $cat = $term->name;
    $bleft_block = <<< END
<div class="hp_bottom_left">
  <a href="{$link}">
    <div class="top">
      <h3>{$cat}</h3>
    </div>
    <img src="{$img}" alt="{$bleft_node->field_bloc_rem_teaser['und'][0]['value']}" />
    <div class="accroche">
      <p>{$bleft_node->field_bloc_rem_teaser['und'][0]['value']}</p>
      <span class="more"></span>
    </div>
  </a>
</div>
END;

    $last_tweet = get_last_tweets(1,"ecofolio");
    $tweet = makeLink($last_tweet[0]->text);
		//print_r($last_tweet);
  $contenu = <<< END
  <div class="hp_first_content">
    {$left_block}
    {$center_block}
    {$right_block}
  </div>
  <div class="hp_second_content">
    {$node_hp->field_homepage_bhtml['und'][0]['value']}
  </div>
  <div class="hp_lsv">
    {$lsv_block}
  </div>
  <div class="hp_third_content">
    {$bleft_block}
    <div class="hp_bottom_center">
      <div class="logo_fb"></div>
      <h4>Rejoignez - nous</h4>
      <hr />
      <iframe src="//www.facebook.com/plugins/likebox.php?href=https%3A%2F%2Fwww.facebook.com%2FRecyclonsLesPapiers&amp;width=220&amp;height=75&amp;colorscheme=light&amp;show_faces=false&amp;header=false&amp;stream=false&amp;show_border=false" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:200px; height:62px;" allowTransparency="true"></iframe>
      <a class="go_on" href="https://www.facebook.com/RecyclonsLesPapiers" target="_blank"></a>
    </div>
    <div class="hp_bottom_right">
      <div class="logo_tw"></div>
      <h4>Suivez - nous</h4>
      <hr />
      <div class="tweeter_name">Ecofolio <a href="https://twitter.com/ecofolio" target="_blank">@ecofolio</a>
      <p class="tweet">{$tweet}</p>
      <a class="go_on" href="https://twitter.com/ecofolio" target="_blank"></a>
    </div>
  </div>
END;

  } else $contenu = '';

  return array("subject"=>"", "content"=>$contenu);
}

	function get_last_tweets($count, $username) {
	   	require_once("lib/twitteroauth.php"); //Path to twitteroauth library
	 
		$twitteruser = $username;
		$consumerkey = "kQRAWDjYc5CSv6yUz3r85V5Ua";
		$consumersecret = "ZNMvn66VnXuHujk7YhvCmVbg4sbxspYUvVQqbr0OiHbMdeMwU6";
		$accesstoken = "588999406-rBdXiUlhmUaOqKo5f4bXOMylCpewRzOTGi6fzwJw";
		$accesstokensecret = "pUq3ZDXlGCCP6SzlMiYOcGGplyyfnQlclZ4rbkLRJFIls";
		 
		function getConnectionWithAccessToken($cons_key, $cons_secret, $oauth_token, $oauth_token_secret) {
			$connection = new TwitterOAuth($cons_key, $cons_secret, $oauth_token, $oauth_token_secret);
			return $connection;
		}
		 
		$connection = getConnectionWithAccessToken($consumerkey, $consumersecret, $accesstoken, $accesstokensecret);
		$tweets = $connection->get("https://api.twitter.com/1.1/statuses/user_timeline.json?screen_name=".$twitteruser."&count=".$count);
		 
		return $tweets;
	}

function makeLink($string){
  $string = preg_replace("/([^\w\/])(www\.[a-z0-9\-]+\.[a-z0-9\-]+)/i", "$1http://$2",$string);
  $string = preg_replace("/([\w]+:\/\/[\w-?&;#~=\.\/\@]+[\w\/])/i","<a target=\"_blank\" href=\"$1\">$1</a>",$string);
  $string = preg_replace("/([\w-?&;#~=\.\/]+\@(\[?)[a-zA-Z0-9\-\.]+\.([a-zA-Z]{2,3}|[0-9]{1,3})(\]?))/i","<a href=\"mailto:$1\">$1</a>",$string);

  return $string;
 }

?>