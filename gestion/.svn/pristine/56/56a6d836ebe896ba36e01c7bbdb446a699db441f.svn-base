<?php

// TODO : mettre les libellés dans un fichier séparé
function _dgf_stagiaire_require_once_files() {
    require_once 'stagiaire_langs.inc';
    require_once 'stagiaire_submit.inc';
    require_once 'stagiaire_validate.inc';
    require_once 'stagiaire_db.inc';
}

/**
 * Fonctions include des JS & CSS
 */
function _dgf_stagiaire_include_js_css() {
    drupal_add_js ( drupal_get_path ( 'module', 'dgf' ) . '/inc/stagiaire/js/stagiaire.js' );
    drupal_add_css ( drupal_get_path ( 'module', 'dgf' ) . '/inc/stagiaire/css/stagiaire.css' );
}

/**
 * Formulaire des types de demande DGF.
 *
 * @param : $form,
 *            &$form_state
 * @return : $form
 *        
 */
function dgf_stagiaire_form($form, &$form_state) {
    _dgf_stagiaire_require_once_files ();
    _dgf_stagiaire_include_js_css ();
    
    // on regarde le 4eme argument de l'url
    $temp_dgf_form_salarie = array ();
    $stagiaire = array ();
    // s'il est rempli, on récupère les informations de la bdd
    if (arg ( 3 ) !== null) {
        
        $id_dgf = shared_security_access_user ( 4, 'DGF' );
        $temp_dgf_form_salarie = salarie_db_get_temp_dgf_form_salarie ( $id_dgf );
        $stagiaire = salarie_db_get_v_salarie ( $temp_dgf_form_salarie ['id_ref_esclave_salarie'] );
    }
    
    shared_get_referentiel_data ( array (
            'ref_diplome',
            'ref_critere_supplementaire'
    ) );
    
    shared_get_referentiel_data_code ( 'ref_diplome' );
    shared_get_referentiel_data_code ( 'ref_critere_supplementaire' );
    
    $form ['cerfa-step'] = array (
            '#type' => 'hidden',
            '#default_value' => '/' . drupal_get_path ( 'theme', 'opcaim' ) . '/images/cerfa-2.png' 
    );
    
    $form ['id_dgf'] = array (
            '#type' => 'hidden',
            '#default_value' => shared_isset_trim ( @$id_dgf ),
            '#title' => t ( 'Id demande' ) 
    );
    
    $form['id_salarie'] = array(
            '#type' => 'hidden',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_esclave_salarie']) : null,
            '#title' => t('Id salarie' ));
    
    $form['info_stagiaire']['recherche_stagiaire'] = array(
            '#type' => 'textfield',
            '#title' => t('Rechercher un stagiaire' ),
            '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />',
    );
        
    $form['info_stagiaire']['matricule'] = array(
            '#type' => 'textfield',
            '#title' => t('Matricule' ),
            '#element_validate' => array('element_shared_nom_validate'),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['matricule']) : null,
    );
    
    $civilites = shared_db_get_title(false);
    $form['info_stagiaire']['man_woman'] = array(
            '#type' => 'radios',
            '#title' => t('Civilité'),
            '#default_value' => ($stagiaire) ? trim($stagiaire['id_civilite']) : null,
            '#options' => $civilites
    );
    
    $form['info_stagiaire']['lastname'] = array(
            '#element_validate' => array('element_shared_nom_validate'),
            '#type' => 'textfield',
            '#default_value' => ($stagiaire) ? trim($stagiaire['nom']) : null,
            '#title' => t('Nom' ),
    );
    
    $form['info_stagiaire']['firstname'] = array(
            '#element_validate' => array('element_shared_nom_validate'),
            '#type' => 'textfield',
            '#default_value' => ($stagiaire) ? trim($stagiaire['prenom']) : null,
            '#title' => t('Prénom' ));
    
    $datepicker_icon = '<span class="glyphicon glyphicon-calendar add-on"></span>';
    
    $form['info_stagiaire']['birthday'] = array(
            '#title' => t('Date de naissance'),
            '#type' => 'textfield',
            '#field_suffix' => $datepicker_icon,
            '#element_validate' => array('element_shared_date_validate'),
            '#default_value' => ($stagiaire) ? date_format(date_create($stagiaire['date_de_naissance']), 'd/m/Y')  : null,
            '#attributes' => array('class' => array('datePicker'),"autocomplete"=>"off", 'placeholder' => t('jj/mm/aaaa'))
    );
    
    $form['info_stagiaire']['csp'] = array(
            '#type' => 'select',
            '#title' => t('CSP'),
            '#default_value' => ($stagiaire) ? trim($stagiaire['id_categorie_socio_professionnelle']) : null,
            '#options' => shared_db_get_csp(true)
    );
    
    $form ['info_stagiaire'] ['contrat'] = array (
            '#type' => 'select',
            '#title' => t ( 'Contrat' ),
            '#default_value' => $temp_dgf_form_salarie ? $temp_dgf_form_salarie['id_ref_type_contrat'] : NULL,
            '#options' => array(t('CDI'), t('CDD')),
    );
    
    $form['info_stagiaire']['diplome'] = array(
            '#type' => 'select',
            '#title' => t('Niveau d\'instruction'),
            '#options' => $_SESSION['referentiel_extranet_data_codes']['ref_diplome'],
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_niveau_de_formation_actuel']) : null,
    );
        
    $form['info_stagiaire']['emploi'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['emploi']) : null,
            '#title' => t('Emploi ou poste occupé' )
    );
    
    $form['info_stagiaire']['handicapped_worker'] = array(
            '#type' => 'radios',
            '#title' => t('Reconnu travailleur handicapé'),
            '#default_value' => ($stagiaire) ? $stagiaire['est_travailleur_handicape'] : null,
            '#options' => array(
                    0 => t('Non'),
                    1 => t('Oui' )
            )
    );
    
    $form['info_stagiaire']['salaire_horaire_brut'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['salaire_horaire_brut']) : null,
            '#title' => t('Salaire horaire brut chargé' ),
            '#field_suffix' => '&euro;/h'
    );

    $form['info_stagiaire']['salaire_horaire_net'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['salaire_horaire_net']) : null,
            '#title' => t('Salaire horaire net' ),
            '#field_suffix' => '&euro;/h'
    );

    $form['info_stagiaire']['critere_supplementaire'] = array(
            '#type' => 'select',
            '#title' => t('Critères supplémentaires'),
            '#options' => $_SESSION['referentiel_extranet_data_codes']['ref_critere_supplementaire'],
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_critere_supplementaire']) : null,
    );
    
    $form['info_action']['cout_pedagogique'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['cout_pedagogique']) : null,
            '#title' => t('Coût pédagogique' ),
            '#field_suffix' => '&euro;'
    );
    
    $form['info_action']['cout_evaluation_preformative'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['cout_evaluation_preformative']) : null,
            '#title' => t('Coût évaluation pré-formative' ),
            '#field_suffix' => '&euro;'
    );
    
    $form['info_action']['frais_transport'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['frais_transport']) : null,
            '#title' => t('Frais transport' ),
            '#field_suffix' => '&euro;'
    );
    
    $form['info_action']['frais_repas'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['frais_repas']) : null,
            '#title' => t('Frais repas' ),
            '#field_suffix' => '&euro;'
    );
    
    $form['info_action']['nb_repas'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['nb_repas']) : null,
            '#title' => t('Nombre de repas ' ),
    );
    
    $form['info_action']['frais_nuitee'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['frais_nuitee']) : null,
            '#title' => t('Frais nuitée' ),
            '#field_suffix' => '&euro;'
    );
    
    $form['info_action']['nb_nuitee'] = array(
            '#type' => 'textfield',
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['nb_nuitee']) : null,
            '#title' => t('Nombre de nuitées' ),
    );
    
    $form['info_action']['duree_eval_preformative_heure'] = array(
            '#type' => 'textfield',
            '#title' => t('Durée' ),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['duree_eval_preformative_heure']) : null,
            '#field_suffix' => t(' h')
    );
    
    $form['info_action']['duree_eval_preformative_minute'] = array(
            '#type' => 'textfield',
            '#title' => t(''),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['duree_eval_preformative_minute']) : null,
            '#field_suffix' => t(' min')
    );
    
    $form['info_action']['mobilisation_cpf'] = array(
            '#type' => 'checkbox',
            '#title' => t('Mobilisation CPF' ),
            '#default_value' => ($temp_dgf_form_salarie && $temp_dgf_form_salarie['mobilisation_cpf']) ? true : false,
    );
    
    $form['info_action']['numero_securite_social'] = array(
            '#type' => 'textfield',
            '#title' => t('Numéro de sécurité sociale' ),
            '#default_value' => ($stagiaire) ? trim($stagiaire['numero_securite_social']) : null,
    );
    
    $form['info_action']['heure_cpf'] = array(
            '#type' => 'textfield',
            '#title' => t('Nombre d\'heures CPF' ),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['heure_cpf']) : null,
    );
    
    $form['info_action']['duree_action'] = array(
            '#type' => 'textfield',
            '#title' => t('Durée de l’action' ),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['duree_action']) : null,
    );
    
    $form['info_action']['duree_action_tt'] = array(
            '#type' => 'textfield',
            '#title' => t('Durée sur temps de travail (STT)' ),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['duree_action_tt']) : null,
    );
    
    $form['info_action']['duree_action_ht'] = array(
            '#type' => 'textfield',
            '#title' => t('Durée hors temps de travail (HTT)' ),
            '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['duree_action_ht']) : null,
    );
    
    $form['import_db_salarie'] = array(
            '#type' => 'button',
            '#value' => t('Importer votre base salariés')
    );
    
    
    // Ajout des boutons d'actions
    $validatorsBoutonNext = array ();
    // 'dgf_contrat_pro_stagiaire_standard_form_validate',
    // 'dgf_contrat_pro_stagiaire_specific_form_validate',
    
    $submitsBoutonNext = array ();
    // 'dgf_contrat_pro_stagiaire_form_submit'
    
    dgf_boutons_action_form ( $form, $validatorsBoutonNext, $submitsBoutonNext );
    
    // Ajout de la modal quitter
    $validatorsQuit = array ();
    // 'dgf_contrat_pro_stagiaire_form_validate'
    
    $validatorsSave = array ();
    // 'dgf_contrat_pro_stagiaire_standard_form_validate',
    // 'dgf_contrat_pro_stagiaire_specific_form_validate'
    
    $submitsSave = array ();
    // 'dgf_contrat_pro_stagiaire_form_submit'
    
    dgf_modal_quit_form ( $form, $validatorsQuit, $validatorsSave, $submitsSave );
    
    return $form;
}

