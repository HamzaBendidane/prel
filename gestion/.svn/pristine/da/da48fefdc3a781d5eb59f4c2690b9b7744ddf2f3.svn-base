(function ($) {

  Drupal.behaviors.zipcart = {
    attach: function (context, settings) {
      $('a.zipcart').once().click(function(e) {
        if (e.target.tagName.toLowerCase() == 'a') {
          a = e.target;
        }
        else {
          if (a = $(e.target).parents('a[href]')) {
            // found parent a
          }
          else {
            return;
          }
        }
        e.preventDefault();
        // handle subdir Drupal installation
        filePath = $(a).attr('href').replace(Drupal.settings.basePath, '');
        if (filePath.indexOf(Drupal.settings.zipcart.path_add) != -1) {
          // add AJAX parameter - add
          filePath = filePath.replace(Drupal.settings.zipcart.path_add, Drupal.settings.zipcart.path_add_ajax);
        }
        else {
          // add AJAX parameter - remove
          filePath = filePath.replace(Drupal.settings.zipcart.path_remove, Drupal.settings.zipcart.path_remove_ajax);
        }
        // add Drupal basePath
        filePath = Drupal.settings.basePath + filePath;
        // remove multiple slashes at start
        filePath = filePath.replace(/^\/+/, '/');

        $.ajax({
          'url': filePath,
          'dataType': 'json',

          success: function(data, textStatus, req) {
            var linkText = $(a).text();
            if (data.action == 'added') {
              $('.block-refresh-button').trigger('click');
            }
            else {
              $('.block-refresh-button').trigger('click');
            }
            Drupal.settings.zipcart.cart = data.cart;
            cart = $('.zipcart-block-downloads');
            animCallback = function(data) {
              $('.zipcart-download-count').html(Object.keys(Drupal.settings.zipcart.cart).length);
            }
          },

          error: function(req, textStatus, errorThrown) {
            alert(Drupal.t('Unable to add the file to your ZipCart.'));

            if (console) {
              console.log(req);
              console.log(textStatus);
              console.log(errorThrown);
            }

            switch (textStatus) {
              case 'timeout' :
              case 'null' :
              case 'error' :
              case 'parsererror' :
              case 'notmodified' :
                break;
              default :
                break;
            }
            // probably not permitted - handle file access restriction here
          }
        });
      });
      $('a.zipcart-zipcart').click(function(e) {
        if (e.target.tagName.toLowerCase() == 'a') {
          a = e.target;
        }
        else {
          if (a = $(e.target).parents('a[href]')) {
            // found parent a
          }
          else {
            return;
          }
        }
        e.preventDefault();
        // handle subdir Drupal installation
        filePath = $(a).attr('href').replace(Drupal.settings.basePath, '');
        filePath = filePath.replace(Drupal.settings.zipcart.path_remove, Drupal.settings.zipcart.path_remove_ajax);
        // add Drupal basePath
        filePath = Drupal.settings.basePath + filePath;
        // remove multiple slashes at start
        filePath = filePath.replace(/^\/+/, '/');

        $.ajax({
          'url': filePath,
          'dataType': 'json',

          success: function(data, textStatus, req) {
            var linkText = $(a).text();
            Drupal.settings.zipcart.cart = data.cart;
            cart = $('.zipcart-block-downloads');
            $(a).closest('tr').animate({ height: 'toggle', opacity: 'toggle' }, 'slow', function() {$(this).remove(); });
            $('.zipcart-download-count').html(Object.keys(Drupal.settings.zipcart.cart).length);
            $('.block-refresh-button').trigger('click');
          },

          error: function(req, textStatus, errorThrown) {
            alert(Drupal.t('Unable to add the file to your ZipCart.'));

            if (console) {
              console.log(req);
              console.log(textStatus);
              console.log(errorThrown);
            }

            switch (textStatus) {
              case 'timeout' :
              case 'null' :
              case 'error' :
              case 'parsererror' :
              case 'notmodified' :
                break;
              default :
                break;
            }
            // probably not permitted - handle file access restriction here
          }
        });
      });
      if ($('.connect .connexion').length > 0) {
        $('a.connexion').bind('click', false);
        $('a.connexion').click(function () {
          var html = $("#login-block-media").html();
          $.colorbox({
            html: html,
            overlayClose: true,
            escKey: true,
            closeButton: true,
            height: '500px',
            width: '650px'
          });
        });
      }
      if ($('.node-type-document').length > 0) {
        $('#download-zipcart').bind('click', false).addClass('test');
        queryRedirect = '?' + $('#download-zipcart').attr('href').split("?").pop()
        $('input[type=checkbox][name=files]').once().click(function() {
          if (this.checked) {
            var url = $('#download-zipcart').attr('href');
            url = url.replace(queryRedirect, '');
            $('#download-zipcart').attr('href', url + '/' + $(this).attr('value') + queryRedirect);
          } else {
            var url = $('#download-zipcart').attr('href');
            url = url.replace('/' + $(this).attr('value'), '');
            $('#download-zipcart').attr('href', url);
          }
          if ($('input[type=checkbox][name=files]:checked').length >= 1) {
            $('#download-zipcart').unbind('click', false).removeClass('test');
          } else {
            $('#download-zipcart').bind('click', false).addClass('test');
          }
        });
        $('input[type=checkbox][name=all-files]').click(function(event) {
          if(this.checked) {
            $('.checkbox-file').each(function() {
              this.checked = true;
              var url = $('#download-zipcart').attr('href');
              if (url.indexOf($(this).attr('value')) >= 0) {
                // Nothing
              } else {
                url = url.replace(queryRedirect, '');
                $('#download-zipcart').attr('href', url + '/' + $(this).attr('value') + queryRedirect);
              }
            });
          }else{
            $('.checkbox-file').each(function() {
              this.checked = false;
              var url = $('#download-zipcart').attr('href');
              url = url.replace('/' + $(this).attr('value'), '');
              $('#download-zipcart').attr('href', url);
            });
          }
        });
        $('#download-zipcart').click(function(event) {
          $('.checkbox-files').checked = false;
          $('.checkbox-file').each(function() {
            this.checked = false;
            var url = $('#download-zipcart').attr('href');
            url = url.replace('/' + $(this).attr('value'), '');
            $('#download-zipcart').attr('href', url);
          });
        });
      }
      if ($('.page-espace-editeur-panier').length > 0) {
        $('.check-button').once().click(function(){
          $('#zipcart-validation-form input[id^=edit-nom], #zipcart-validation-form select').each(function() {
            if ($('.item-in-cart').length) {
              if(!$(this).val()){
                $(this).parent().addClass('empty-field');
              } else {
                $(this).parent().removeClass('empty-field');
              }
            } else {
              alert('Votre panier est vide.').once();
            }
          });
          var $emptyFields = $("#zipcart-validation-form input[id^=edit-nom], #zipcart-validation-form select").filter(function() {
            return $.trim(this.value) === "";
          });
          if (!$emptyFields.length) {
            if ($('.item-in-cart').length) {
              $('#edit-submit').once().click();
              setTimeout(function(){
                $('#download-cart')[0].click();
              }, 1000);
              $('#edit-end-confirmation').fadeIn();
            } else {
              alert('Votre panier est vide.');
            }
          }
        });
      }
    }
  };
})(jQuery);
