(function ($) {
    var need_scroll = true;
    $(document).ready(function() {
        var nb_page = parseInt($( "#ajaxMaxPage" ).val());
        
        $("form#ecofolio-display-mediatheque-filters-order-form").hide();
        var val_order = $(".filters-order #edit-filters-order").val();
        if(val_order==0) $("form#ecofolio-display-mediatheque-filters-order-form").parent().append('<a href="" class="order"><span class="moins"></span>Du plus récent au plus ancien</a>');
        if(val_order==1) $("form#ecofolio-display-mediatheque-filters-order-form").parent().append('<a href="" class="order"><span class="plus"></span>Du plus ancien au plus récent</a>');
        $("form#ecofolio-display-mediatheque-filters-order-form").parent().find("a.order").on('click', function() {
          var val_order = $(".filters-order #edit-filters-order").val();
          if(val_order==0) $(".filters-order #edit-filters-order").val(1);
          if(val_order==1) $(".filters-order #edit-filters-order").val(0);
          callAjaxData(1);
          return false;
        });

        
        $(window).scroll( function(){
          var page_actuel = parseInt($( "#ajaxPage" ).val());
          var elem_position = $('.results-medias').height();
          var scroll_position = $(this).scrollTop()+800;
          if(scroll_position >= elem_position && page_actuel<nb_page && need_scroll) {
            need_scroll = false;
            callAjaxData(page_actuel+1);
          }
        });

        $("body").off('click', '.media-cpu');
        $("body").off('click', 'a.user-not-allowed');
        $("body").off('submit', '#colorbox #ecofolio-manage-mediatheque-cgu-form');
        $("body").off('submit', '#colorbox #ecofolio-manage-mediatheque-cpu-form');
        
        $("body").on('submit', '#colorbox #ecofolio-manage-mediatheque-cpu-form', function() {
            var error = false;
            $("#colorbox #messagesCPU .messages.error").html('');

            if ($("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-prenom").val() == '') {
                $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-prenom").addClass('error');
                $("#colorbox #messagesCPU .messages.error").append('Le champs Prénom est obligatoire <br />');
                error = true;
            } else {
                $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-prenom").removeClass('error');
            }

            if ($("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-nom").val() == '') {
                $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-nom").addClass('error');
                $("#colorbox #messagesCPU .messages.error").append('Le champs Nom est obligatoire <br/>');
                error = true;
            } else {
                $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-nom").removeClass('error');
            }

            if ($('#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-email').val() == '') {
                $('#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-email').addClass('error');
                $("#colorbox #messagesCPU .messages.error").append('Le champs Email est obligatoire <br/>');
                error = true;
            } else {
                var reg = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (!reg.test($('#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-email').val()))
                {
                    $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-email").addClass('error');
                    $("#colorbox #messagesCPU .messages.error").append('Merci de saisir une adresse électronique valide <br/>');
                    error = true;
                } else {
                    $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-email").removeClass('error');
                }
            }

            if ($('#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-cpu').prop('checked') == false) {
                $("#colorbox #messagesCPU .messages.error").append('Vous devez accepter les Conditions Particulières d\'Utilisation pour accéder à ce contenu <br/>');
                error = true;
            } else {
                $("#colorbox #ecofolio-manage-mediatheque-cpu-form #edit-personnal-info-cpu").removeClass('error');
            }
            
            if (error) {
                return false;
            }
        });

        $("body").on('submit', '#colorbox #ecofolio-manage-mediatheque-cgu-form', function() {
            var error = false;
            $("#colorbox #messagesCGU .messages.error").html('');

            if ($('#colorbox #ecofolio-manage-mediatheque-cgu-form #edit-cgu').prop('checked') == false) {
                $("#colorbox #messagesCGU .messages.error").append('Vous devez accepter les Conditions Générales d\'Utilisation pour accéder à ce contenu <br/>');
                error = true;
            } else {
                $("#colorbox #ecofolio-manage-mediatheque-cgu-form #edit-cpu").removeClass('error');
            }
            
            if (error) {
                return false;
            }
        });
        
        $(".media-filters .hideFilter").click(function() {
            $(".media-filters .filters-items").hide();
            $("span.hideFilter").hide();
            $("span.plusFilter").show();
        });
        $(".media-filters .plusFilter").click(function() {
            $(".media-filters .filters-items").show();
            $("span.hideFilter").show();
            $("span.plusFilter").hide();
        });
        
        $(".media-filters .filters-taxo input").change(function() {
            $(".media-filters .filters-taxo input").each(function() {
                $(this).prop("checked", false);
            });
            $(this).prop("checked", true);
            callAjaxData(1);
        });
        
        $(".media-filters .filters-assets input").change(function() {
            $(".media-filters .filters-assets input").each(function() {
                $(this).prop("checked", false);
            });
            $(this).prop("checked", true);
            callAjaxData(1);
        });
        
        $(".media-filters #edit-filters-range").change(function() {
            callAjaxData(1);
        });
        
        $("#edit-filters-order").change(function() {
            callAjaxData(1);
        });
        
        $(".filters-search-range #edit-submit").click(function() {
            callAjaxData(1);
        });
        
        $("body").on('click', '#pagerWrapper .goToPage', function() {
            callAjaxData($(this).data('pagenumber'));
        });
    

        
        if ($("#CPU").length > 0) {
            $.colorbox({
                html:$("#CPU").html(),
                width:"80%",
                overlayClose: false,
                escKey: false,
                closeButton: false
            });
        }
        
        if ($("#CGU").length > 0) {
            $.colorbox({
                html:$("#CGU").html(),
                width:"80%",
                overlayClose: false,
                escKey: false,
                closeButton: false
            });
        }
        
        $("body").on('click', '.media-cpu', function() {
            $('.ecofolio-manage-mediatheque-cpu-form input[name="nid"]').val($(this).data('nid'));
            $('.ecofolio-manage-mediatheque-cpu-form input[name="href"]').val($(this).attr('href'));
            var html = $(this).parent().find(".bodyCPU").html();
            $("#CPUform #CPUContent").html(html);
            $.colorbox({
                html: $("#CPUform").html(),
                width:"80%",
                overlayClose: false,
                escKey: false,
                closeButton: false
            });
            return false;
        });
        
        $("body").on('click', 'a.not-allowed', function() {
            if ($(this).data('userlogged') === false) {
                var html = $("#login-block-media").html();
                $.colorbox({
                    html: html,
                    overlayClose: true,
                    escKey: true,
                    closeButton: true,
                    height: '500px',
                    width: '650px'
                });
            } else {
                var roleAllowed = $(this).data('roleallowed');
                $("#access-not-allowed .roleAccess").html(roleAllowed);
                var html = $("#access-not-allowed").html();
                $.colorbox({
                    html: html,
                    overlayClose: true,
                    escKey: true,
                    closeButton: true,
                    height: '150px'
                });
            }
            return false;
        });
    });
    


    function callAjaxData(page) {
        $("#ajaxPage").val(page);
        if (page > 1) {
            $(".essentials-medias").hide();
        } else {
            $(".essentials-medias").show();
        }
        var taxoSelected = [];
        var assetSelected = [];
        var range = 10;
        var keywords = '';
        var order = 0;
        
        $(".media-filters .filters-taxo input").each(function() {
            if ($(this).attr('checked')) {
                taxoSelected[taxoSelected.length] = $(this).val();
            }
        });
        
        $(".media-filters .filters-assets input").each(function() {
            if ($(this).attr('checked')) {
                assetSelected[assetSelected.length] = $(this).val();
            }
        });
        
        range = $(".media-filters .filters-search-range select").val();
        keywords = $(".media-filters #edit-filters-search").val();
        order = $(".filters-order #edit-filters-order").val();
        
        // On fait un appel ajax pour récupérer les données à afficher
        var url = $("#ajaxPostUrl").val();
        var univers = $("#ajaxUnivers").val();
        $.ajax({
            type: 'POST',
            url: url+'/'+univers,
            data: { 
                taxoSelected: taxoSelected,
                assetSelected: assetSelected,
                range: range,
                keywords: keywords,
                order: order,
                page: page
            },
            beforeSend : function() {
                // afficher un overlay
                if(page == 1) $("#customOverlay").show();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                // effacer un overlay
                $("#customOverlay").hide();
                alert(textStatus + '\n' + errorThrown);
            },
            success : function(result, textStatus, jqXHR) {
                if (result.status == true) {
                    if (result.htmlEssentials != '' && page == 1) {
                        $(".essentials-medias").show();
                    } else {
                        $(".essentials-medias").hide();
                    }
                    $(".essentials-list").html(result.htmlEssentials);
                    if(page == 1) $(".results-medias").html(result.htmlResults);
                    else $(".results-medias").append(result.htmlResults);
                    $("#pagerWrapper").html(result.htmlPager);
                    if (result.nbResultTot > 1) {
                        $(".nb-results").html(result.nbResultTot + ' médias disponibles');
                    } else {
                        $(".nb-results").html(result.nbResultTot + ' média disponible');
                    }
                    
                    if(page == 1) {
                      $('html, body').animate({
                          scrollTop: $("#view-mediatheque").offset().top - 30
                      });
                    }
                    
                    var val_order = $(".filters-order #edit-filters-order").val();
                    if(val_order==0) $("form#ecofolio-display-mediatheque-filters-order-form").parent().find('a.order').html('<span class="moins"></span>Du plus récent au plus ancien');
                    if(val_order==1) $("form#ecofolio-display-mediatheque-filters-order-form").parent().find('a.order').html('<span class="plus"></span>Du plus ancien au plus récent');
                    need_scroll = true;
                } else {
                    alert('Un problème est intervenu lors de la récupération des données.');
                }
            },
            complete : function() {
                // effacer un overlay
                if(page == 1) $("#customOverlay").hide();
            }
        });
        return false;
    }
}(jQuery));