<?php
/**
 * Ajout des fichiers requis pour le dashboard
 * @author Gael GALBAS-FRONTINOIS
 */

function _dashboard_required() {
  $path = drupal_get_path('module', 'dashboard');
  drupal_add_css($path . '/css/dashboard.css');
  drupal_add_js ($path . '/js/dashboard.js');
  require_once 'dashboard_bloc.inc';
}


/**
 * Cette fonction extrait le uid user.
 * @author Gael GALBAS-FRONTINOIS
 * @return uid de l'utilisateur
 */
function _dashboard_access_callback() {
  global $user;
  return $user->uid;
}


function _dashboard_require_once_files() {
  require_once 'dashboard_db.inc';
}


/**
 * Hook_menu
 * @author Gael GALBAS-FRONTINOIS
 * @return Item du menu
 */function dashboard_menu() {
  $items = array();
  $items['dashboard'] = array(
      'title' => t('Dashboard'),
      'page callback' => 'dashboard_view',
      'access callback' => '_dashboard_access_callback',
      'type' => MENU_CALLBACK,
  );
  return $items;
}


/**
 * Cette fonction extrait les roles utilisateur.
 * @author Gael GALBAS-FRONTINOIS
 * @return array : tableau contenant les roles de l'utilisateur
 */
function dashboard_get_roles_user() {
  global $user;
  return  $user->roles;
}

/**
 * Retourne les blocs dashboard à afficher pour un role
 * @author Gael GALBAS-FRONTINOIS
 * @param role role
 * @return blocs : blocs dashboard à afficher
 */
function dashboard_get_bloc_habilitation ($habilitation) {
  $blocs =  array();
  switch ($habilitation) {
//     case 'COLLABORATEUR ENTREPRISE':
    case 'DAS_ENU':
      if(shared_user_access('SAI_DGF_CP') || shared_user_access('SAI_DGF_TA')) {
        $blocs[] = 'saisir_une_demande';
      }
      $blocs[] = 'mes_dossiers_en_cours';
      $blocs[] = 'mon_activité_formation';
      $blocs[] = 'mes_documents';
      $blocs[] = 'administration';
      $blocs[] = 'mes_cotisations_mes_contributions';

      break;

//     case 'UTILISATEUR ADEFIM':
    case 'DAS_ADH':
      $blocs= array(
        'gestion_des_comptes',
        'les_demandes_en_cours',
        'suivi_des_dossiers',
        'la_collecte'
      );
      break;

//     case 'ADMIN OPCAIM':
    case 'DAS_OPA':
      $blocs= array(
        'gestion_des_comptes',
        'les_demandes_en_cours',
        'administration',
        'suivi_de_l_activité_extranet',
        'collecte_contributions'
      );
      break;

//       case 'ORGANISME DE FORMATIONS':
    case 'DAS_OGF':
        $blocs= array(
        'les_demandes_en_attentes_d_accord',
        'les_actions_en_cours_avec_paiement_opca_paiement_entreprise',
        'mes_demandes_et_dossiers'
       );
       break;
  }
  return $blocs;
}

/**
 * Retourne les blocs dashboard à afficher pour l'utilisateur en  cours
 * @author Gael GALBAS-FRONTINOIS
 * @return blocs : blocs dashboard à afficher
 */
function dashboard_get_liste_blocs_habilitations($habilitations) {

  $blocs = array();
  foreach ($habilitations as $habilitation) {
    $blocs = array_merge($blocs, dashboard_get_bloc_habilitation($habilitation));
  }

  return array_unique($blocs);
}


/**
 *  Hook_view()
 * @author Gael GALBAS-FRONTINOIS
 *
 */
function dashboard_view() {
  global $user;
  shared_update_user_entreprises();
  _dashboard_required();
  _dashboard_require_once_files();

  $user_drupal = _dashboard_access_callback();

  // Extraction des entreprise de l'utilisateur
  $user_extranet = shared_get_drupal_user_id($user_drupal);
  $lien_user_entreprise_ref_esclave_entreprise = shared_db_get_lien_user_entreprise_ref_esclave_entreprise($user_extranet);

  $lst_habilitations = array();
  if(shared_user_access('DAS_ENU')) {
    $lst_habilitations[] = 'DAS_ENU';
  }

  if(shared_user_access('DAS_ADH')) {
    $lst_habilitations[] = 'DAS_ADH';
  }

  if(shared_user_access('DAS_OGF')) {
    $lst_habilitations[] = 'DAS_OGF';
  }

  if(shared_user_access('DAS_OPA')) {
    $lst_habilitations[] = 'DAS_OPA';
  }

  $entreprises = array();
  foreach ($lien_user_entreprise_ref_esclave_entreprise as $row) {
    $entreprises[] = $row->id_ref_esclave_entreprise;
  }

  $variables = array();
  $variables['blocs'] = array();
  $liste_blocs = dashboard_get_liste_blocs_habilitations($lst_habilitations);

  // Attribution des poids et uniticité pour l'affichage
  $poids_blocs = array(
      1 => 'saisir_une_demande',
      2 => 'mes_dossiers_en_cours',
      3 => 'mon_activité_formation',
      4 => 'mes_documents',
      5 => 'administration',
      6 => 'mes_cotisations_mes_contributions',
      7 => 'gestion_des_comptes',
      8 => 'les_demandes_en_cours',
      9 => 'suivi_des_dossiers',
      10 => 'la_collecte',
      11 => 'les_dossiers_en_cours',
      12 => 'suivi_de_l_activité_extranet',
      13 => 'collecte_contributions',
      14 => 'les_demandes_en_attentes_d_accord',
      15 => 'les_actions_en_cours_avec_paiement_opca_paiement_entreprise',
      16 => 'mes_demandes_et_dossiers'
  );

  $lst_blocs_ponderes = array();
  foreach ($poids_blocs as $bloc_pondere) {
    if(in_array($bloc_pondere, $liste_blocs)) {
      $lst_blocs_ponderes[] = $bloc_pondere;
    }
  }
  $liste_blocs = $lst_blocs_ponderes;
  // Fin attribution des poids pour l'affichage


  $blocs = array();
  foreach ($liste_blocs as $bloc) {
    $bloc_info = dashboard_get_infos_bloc($bloc, $user_extranet, $entreprises);
    switch ($bloc_info['type']) {
      case 'couleur' :
        $variables['blocs'][] = theme('bloc_couleur_theme', $bloc_info);
        break;

      case 'blanc' :
        $variables['blocs'][] = theme('bloc_blanc_theme', $bloc_info);
        break;
      }

  }
  $output = theme('dashboard_theme', $variables);
  return $output;
}



/**
*  Implementation of hook_theme().
*  @author Gael GALBAS-FRONTINOIS
*
*/
function dashboard_theme($existing, $type, $theme, $path) {
  // TODO : ajouter plusieurs template suivant le rôle du user
  return array(
      // Template général pour afficher la médiathèque
      'dashboard_theme' => array(
          'variables' => array(),
          'render element' => 'element',
          'template' => 'dashboard',
          'path' => drupal_get_path('module', 'dashboard') .'/theme',
      ),
      'bloc_couleur_theme' => array(
          'variables' => array(),
          'render element' => 'element',
          'template' => 'dashboard_bloc_couleur',
          'path' => drupal_get_path('module', 'dashboard') .'/theme',
      ),
      'bloc_blanc_theme' => array(
          'variables' => array(),
          'render element' => 'element',
          'template' => 'dashboard_bloc_blanc',
          'path' => drupal_get_path('module', 'dashboard') .'/theme',
      ),
  );
}