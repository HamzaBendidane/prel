<?php

/**
 * creation_compte_entreprise_form_submit
 *
 * Soumission du form
 *
 * @param unknown $form
 * @param unknown $form_state
 */
function creation_compte_entreprise_form_submit($form, &$form_state) {
  // Si l'utilisateur est sur le premier formulaire et qu'il clique sur suivant
  // On rebuild le form avec la page confirmation
  if ($form_state['triggering_element']['#id'] == 'edit-next') {
    $form_state['storage']['display_page'] = 'confirmation';
    $form_state['storage']['creation_compte_entreprise_formulaire_form_data'] = $_POST;
    $form_state['rebuild'] = TRUE;
  } else if ($form_state['triggering_element']['#id'] == 'edit-confirmer') {
    $form_state['storage']['display_page'] = 'charte';
    $form_state['storage']['creation_compte_entreprise_confirmation_form_data'] = $form_state['values'];
    $form_state['rebuild'] = TRUE;
  } else if ($form_state['triggering_element']['#id'] == 'edit-back') {
    $form_state['storage']['display_page'] = 'formulaire';
    $form_state['rebuild'] = TRUE;
  } else {
    _creation_compte_entreprise_form_submit_save_data($form, $form_state);
  }
}


/**
 * _creation_compte_entreprise_form_submit_save_data
 *
 * Fonction qui fait la sauvegarde en BDD
 *
 * @param unknown $form
 * @param unknown $form_state
 */
function _creation_compte_entreprise_form_submit_save_data($form, &$form_state) {
  $fonctionnalites = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_fonctions'];
  $data_email = array(
      'utilisateur' => array(
          'name' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_prenom'] . ' '
            . $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_nom'],
          'numero_demande' => null,
          'email' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'],
          'fonctionnalites' => _creation_compte_entreprise_get_fonctionnalites($fonctionnalites),
          'entreprise' => null,
      ),
      'responsable' => array(
          'name' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_prenom'] . ' '
            . $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_nom'],
          'email' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_email'],
      )
  );

  // On sauvegarde le user Drupal
  $new_user = array(
      'name' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'],
//       'pass' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_password']['pass1'],
      'mail' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'],
      'init' => $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'],
      'status' => 0,
      'access' => REQUEST_TIME,
      'roles' => array('7' => 'COLLABORATEUR ENTREPRISE'),
  );
  // $account returns user object
  $account = user_save(null, $new_user);
  $id_drupal_user = $account->uid;

  // On sauvegarde le ou les établissements avec les adresses et liens adefims
  $id_entreprises = creation_compte_entreprise_db_save_etablissement($form_state, $data_email);

  // On sauvegarde le responsable entreprise
  $id_user_responsable = creation_compte_entreprise_db_save_user_responsable($form_state);

  // On sauvegarde le drupal_user de la BDD extranet avec $id_drupal_user
  $id_extranet_drupal_user = creation_compte_entreprise_db_save_extranet_drupal_user($form_state, $id_drupal_user);

 // On sauvegarde le user_entreprise avec $id_extranet_drupal_user
  $id_user_entreprise = creation_compte_entreprise_db_save_user_entreprise($form_state, $id_extranet_drupal_user,
      $id_user_responsable);

  // save habilitations liés aux utilisateurs
  creation_compte_entreprise_db_save_user_habilitations($form_state, $id_extranet_drupal_user);

  // save entreprises liés aux utilisateurs
  creation_compte_entreprise_db_save_lien_entreprise($form_state, $id_user_entreprise, $id_entreprises);

  // envoie des mails (utilisateur, responsable et adefim)
  //_creation_compte_submit_send_email($data_email);

  /*
   * creation de la notification_event
   */
  $data = array (
            'id_user_entreprise' => $id_user_entreprise,
            'callback_param' => array(
                'id_entreprises' => $id_entreprises,
                'id_user' => $id_drupal_user
            )
  );

  //Création des notification_event
  create_notification_event('GST_DEM_CRE_ETP_VAL', $data);
  create_notification_event('GST_DEM_CRE_ETP_INF', $data);
  
  /*
   * Création de la notification_event 
   */
  $data['numero_demande'] = $_SESSION['creation_compte_entreprise']['numero_demande'];
  $data['name_utilisateur'] = $data_email['utilisateur']['name'];
  $data['fonctionnalites'] = $data_email['utilisateur']['fonctionnalites'];
  $data['entreprises'] = $id_entreprises;
  
  create_notification_event('MAIL_CRE_USR_VAL', $data);
  create_notification_event('MAIL_CRE_USR_RESP', $data);
  create_notification_event('MAIL_CRE_USR_USR', $data);
  
  

  // On redirige l'utilisateur vers une page de fin de process confirmation (texte à mettre)
  drupal_goto('/creation/compte/entreprise/fin');
}

/**
 * _creation_compte_entreprise_get_fonctionnalites
 *
 * @param array $fonctionnalites
 *
 * @return array $user_habilitations
 */
function _creation_compte_entreprise_get_fonctionnalites($fonctionnalites) {
  $habilitations = shared_get_habilitation();

  $user_habilitations = array();
  foreach ($fonctionnalites as $key => $fonctionnalite) {
    if ($fonctionnalite !== 0) {
      $user_habilitations[] = $habilitations[$key];
    }
  }

  return $user_habilitations;
}

function _creation_compte_submit_send_email($data_email) {
  $data_email['utilisateur']['numero_demande'] = $_SESSION['creation_compte_entreprise']['numero_demande'];
  $from = variable_get('site_mail', 'admin@opcaim.com');

  // Mail 1 : mail au user
  $param_utilisateur = array(
      'name' => $data_email['utilisateur']['name'],
      'numero_demande' => $data_email['utilisateur']['numero_demande'],
  );

  $to = $data_email['utilisateur']['email'];
  // send mail
  $send_mail = drupal_mail('creation_compte', 'creation_compte_entreprise_user', $to, language_default(),
      $param_utilisateur, $from, TRUE);

  // Mail 2 : mail au responsable
  $param_responsable = array(
      'name_responsable' => $data_email['responsable']['name'],
      'name_collaborateur' => $data_email['utilisateur']['name'],
      'fonctionnalites' => implode( "\r\n", $data_email['utilisateur']['fonctionnalites']),
  );

  $to = $data_email['responsable']['email'];
  // send mail
  $send_mail = drupal_mail('creation_compte', 'creation_compte_entreprise_responsable', $to, language_default(),
      $param_responsable, $from, TRUE);

  // Mail 3 : mail aux ADEFIM (attention, il peut y en avoir plusieurs et on regroupe les établissements par ADEFIM)
  if (isset($data_email['adefim'])) {
    foreach ($data_email['adefim'] as $key => $adefims) {
      $id_adefim = $key;
      foreach ($adefims as $key => $entreprise_siret) {
        $etablissements[] = $entreprise_siret['raison_sociale'] . ' (' . $entreprise_siret['siret'] . ')';
      }

      // On regarde en BDD les users adefims pour envoyer les emails
      db_set_active(@DB_SLAVE);
      $query = db_select('v_comptes_adefims', 'ca');
      $query->fields('ca');
      $query->condition('id_adefim', $id_adefim, '=');
      $result = $query->execute();
      $comptes_adefim = $result->fetchAll();
      db_set_active();

      foreach ($comptes_adefim as $compte_adefim) {
        $param_adefim = array(
            'name' => trim($compte_adefim->prenom) . ' ' . trim($compte_adefim->nom),
            'numero_demande' => $data_email['utilisateur']['numero_demande'],
            'name_utilisateur' => $data_email['utilisateur']['name'],
            'etablissements' => implode("\r\n", $etablissements),
        );
        $to = trim($compte_adefim->email);
        // send mail
        $send_mail = drupal_mail('creation_compte', 'creation_compte_entreprise_adefim', $to, language_default(),
            $param_adefim, $from, TRUE);
      }
    }
  }
}