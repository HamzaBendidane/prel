<?php

/**
 * creation_compte_entreprise_db_save_etablissement
 *
 * Fonction qui permet de cr�er ou modifier le ou les �tablissements de l'utilisateur
 *
 * @param array $form_state
 * @param array $data_email
 */
function creation_compte_entreprise_db_save_etablissement($form_state, &$data_email) {
  global $user; // User Drupal

  $nb_siret = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['nb_siret'];

  $id_civilite = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_titre'];
  $prenom = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_prenom'];
  $nom = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_nom'];
  $telephone = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_telephone'];
  $email = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'];
  $id_fonction = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_fonction'];

  $id_entreprises = array();
  for ($i=0; $i < $nb_siret ; $i++) {

    // on r�cup�re les donn�es de l'�tablissement
    $siret = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['siret'][$i];
    $raison_sociale = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['raison_sociale'][$i];
    //     $tel = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company_telephone'][$i];
    $tel = 'NULL';
    $id_naf = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['id_naf'][$i];
    $id_nace = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['id_nace'][$i];
    $id_secteur_activite = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['id_filiere'][$i];
    $id_secteur_activite2 = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['id_filiere2'][$i];

    // on r�cup�re les donn�es de l'adresse de l'�tablissement
    $adresse = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['adresse'][$i];
    $complement_adresse = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['complement_adresse'][$i];
    $complement_adresse_2 = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['complement_adresse_2'][$i];

    $code_postal = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['code_postal'][$i];
    $ville = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['company']['ville'][$i];

    // on regarde si l'entreprise existe d�j�
    $info_etablissement = shared_db_get_entreprise_from_siret($siret);

    // Gestion des donn�es pour la proc�dure stock�e sp_sauver_entreprise
    $proc_stock_data_etablissement = array(
        'id' => NULL,
        'user' => 'anonyme',
        'raison_sociale' => $raison_sociale,
        'siret'   => $siret,
        'id_naf'  => $id_naf,
        'id_nace' => $id_nace,
        'est_en_cours_immatriculation' => 0,
        'telephone_principal' => $tel,
        'telephone_secondaire' => NULL,
        'fax' => NULL,
        'site_web' => NULL,
        'email' => NULL,
        'tva_intracommunautaire' => NULL,
        'id_categorie' => NULL,
        'id_departement' => NULL,
        'est_hors_branche' => 0,
        'id_taux_de_tva' => NULL,
        'id_secteur_activite' => $id_secteur_activite,
        'id_convention_collective' => NULL,
        'est_geiq' => 0
    );

    // Gestion des donn�es pour la proc�dure stock�e sp_sauver_adresse_entreprise
    $proc_stock_data_adresse = array(
        'user' => 'anonyme',
        'id' => NULL,
        'id_type_adresse' => NULL,
        'rue' => $adresse,
        'complement_de_rue' => $complement_adresse,
        'complement_de_rue_2' => $complement_adresse_2,
        'code_postal' => $code_postal,
        'ville' => $ville,
        'id_region' => NULL,
        'id_entreprise' => NULL
    );

    // Si l'�tablissement existe d�j�, on met � jour les donn�es par la proc�dure stock�e
    if (isset($info_etablissement->id)) {
      $proc_stock_data_etablissement['id'] = $info_etablissement->id;
      if ($raison_sociale != trim($info_etablissement->raison_sociale)
          || $id_nace != trim($info_etablissement->id_nace)
          || $id_secteur_activite != trim($info_etablissement->id_secteur_activite)) {
        $id_entreprise = _creation_compte_entreprise_db_call_proc_stock_etablissement($proc_stock_data_etablissement);
      } else {
        $id_entreprise = trim($info_etablissement->id);
      }
      // On r�cup�re l'adresse de l'�tablissement
      $adresse_entreprise = shared_db_get_adresse_entreprise_from_id_entreprise($info_etablissement->id);
      if ($adresse != trim($adresse_entreprise->rue)
          || $complement_adresse != trim($adresse_entreprise->complement_de_rue)
          || $complement_adresse_2 != trim($adresse_entreprise->complement_de_rue_2)
          || $code_postal != trim($adresse_entreprise->code_postal)
          || $ville != trim($adresse_entreprise->ville)) {
            $proc_stock_data_adresse['id'] = $adresse_entreprise->id;
            $proc_stock_data_adresse['id_entreprise'] = $id_entreprise;
            $id_adresse_entreprise = _creation_compte_entreprise_db_call_proc_stock_adresse_etablissement(
                $proc_stock_data_adresse);
      } else {
        $id_adresse_entreprise = trim($adresse_entreprise->id);
      }
    } else {
      $id_entreprise = _creation_compte_entreprise_db_call_proc_stock_etablissement($proc_stock_data_etablissement);
      $proc_stock_data_adresse['id_entreprise'] = $id_entreprise;
      $id_adresse_entreprise = _creation_compte_entreprise_db_call_proc_stock_adresse_etablissement(
          $proc_stock_data_adresse);
      // Gestion des donn�es pour la proc�dure stock�e sp_sauver_adresse_entreprise
      $proc_stock_data_contact = array(
          'user' => 'anonyme',
          'id' => NULL,
          'id_entreprise' => $id_entreprise,
          'id_civilite' => $id_civilite,
          'prenom' => $prenom,
          'nom' => $nom,
          'telephone' => $telephone,
          'email' => $email,
          'fax' => NULL,
          'id_fonction' => $id_fonction,
          'est_contact_principal' => 1
      );
      $id_contact_entreprise = _creation_compte_entreprise_db_call_proc_stock_contact_etablissement(
          $proc_stock_data_contact);
    }

    // On regarde en BDD le lien entre adefim et entreprise pour envoyer les emails � ces user
    $adefims = shared_get_adefim_from_siret_entreprise($siret);

    foreach ($adefims as $adefim) {
      $id_adefim = $adefim->id_adefim;
      $data_email['adefim'][$id_adefim][] = array(
          'siret' => $siret,
          'raison_sociale' => $raison_sociale,
          'adefim' => $id_adefim,
      );
    }

    $id_entreprises[] = $id_entreprise;
  }

  return $id_entreprises;
}

/**
 * _creation_compte_entreprise_db_call_proc_stock_etablissement
 *
 * @param array $proc_stock_data
 *
 * @return string $id_entreprise
 */
function _creation_compte_entreprise_db_call_proc_stock_etablissement($proc_stock_data) {
  global $user;
  db_set_active(@DB_SLAVE);

  $id_entreprise = shared_execute_procedure('sp_sauver_entreprise', $proc_stock_data);
  db_set_active();

  return $id_entreprise;
}

/**
 * _creation_compte_entreprise_db_call_proc_stock_adresse_etablissement
 *
 * @param array $proc_stock_data
 *
 * @return string $id_entreprise
 */
function _creation_compte_entreprise_db_call_proc_stock_adresse_etablissement($proc_stock_data) {
  global $user;
  db_set_active(@DB_SLAVE);

  $id_adresse_entreprise = shared_execute_procedure('sp_sauver_adresse_entreprise', $proc_stock_data);
  db_set_active();

  return $id_adresse_entreprise;
}
/**
 * _creation_compte_entreprise_db_call_proc_stock_contact_etablissement
 *
 * @param array $proc_stock_data
 *
 * @return string $id_entreprise
 */
function _creation_compte_entreprise_db_call_proc_stock_contact_etablissement($proc_stock_data) {
  global $user;
  db_set_active(@DB_SLAVE);

  $id_adresse_entreprise = shared_execute_procedure('sp_sauver_contact_entreprise', $proc_stock_data);
  db_set_active();

  return $id_adresse_entreprise;
}


/**
 * creation_compte_entreprise_db_save_user_responsable
 *
 * Sauvegarde les infos d'un responsable entreprise
 * Nom de la table: @TABLE_USER_RESPONSABLE
 *
 * @param array $form_state
 *
 * @return int $id_user_responsable
 */
function creation_compte_entreprise_db_save_user_responsable($form_state) {
  global $user;

  db_set_active(@DB_EXTRANET);

  $responsable_titre = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_titre'];
  $responsable_nom = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_nom'];
  $responsable_prenom =  $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_prenom'];
  $responsable_email = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_email'];
  $responsable_fonction = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['responsable']['responsable_fonction'];


  $id_user_responsable = db_insert('user_responsable')
  ->fields( array(
      'civilite' => $responsable_titre,
      'nom'      => $responsable_nom,
      'prenom'   => $responsable_prenom,
      'email'    => $responsable_email,
      'fonction' => $responsable_fonction,
  ))
  ->execute();

  db_set_active();

  return $id_user_responsable;
}

/**
 * creation_compte_entreprise_db_save_extranet_drupal_user
 *
*  Sauvegarde les infos d'un utilisateur entreprise
 *  Nom de la table: drupal_user
 *
 *  @param array $form_state
 *  @param int $id_user_drupal
 *
 *  @return int $id_extranet_drupal_user
 */
function creation_compte_entreprise_db_save_extranet_drupal_user($form_state, $id_user_drupal) {
  global $user;

  db_set_active(@DB_EXTRANET);

  $utilisateur_titre = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_titre'];
  $utilisateur_nom = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_nom'];
  $utilisateur_prenom =  $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_prenom'];
  $utilisateur_email = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_email'];
  $utilisateur_fonction = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_fonction'];
  $utilisateur_telephone = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_telephone'];

  $id_extranet_drupal_user = db_insert('drupal_user')
    ->fields( array(
        'civilite' => $utilisateur_titre,
        'last_name' => $utilisateur_nom,
        'first_name' => $utilisateur_prenom,
        'mail' =>$utilisateur_email,
        'fonction' => $utilisateur_fonction,
        'telephone' => $utilisateur_telephone,
        'date_creation' => shared_send_to_mssql_date(null,'datetime'),
        'id_user_creation' => $user->uid,
        'is_delete' => 0,
        'id_user_drupal' => $id_user_drupal,
        'statut' => 0,
    ))
    ->execute();

  db_set_active();

  return $id_extranet_drupal_user;
}

/**
 * creation_compte_entreprise_db_save_user_entreprise
 *
 * Sauvegarde le user_entreprise
 *
 * @param array $form_state
 * @param int $id_user_responsable
 * @param int $id_user_responsable
 *
 * @return int $id_user_entreprise
 */
function creation_compte_entreprise_db_save_user_entreprise($form_state, $id_extranet_drupal_user, $id_user_responsable) {
  global  $user;

  db_set_active(@DB_EXTRANET);

  // Renvoie le dernier num�ro de demande
  $sql = db_select('user_entreprise' , 'n')
  ->fields('n' , array('numero_demande'))
  ->orderBy('id' , 'DESC')
  ->execute();

  $numero_demande = intval($sql->fetchField()) + 1;
  $nom_signe = $form_state['values']['signature'];
  $_SESSION['creation_compte_entreprise']['numero_demande'] = $numero_demande;

  // SQL INSERT
  $id_user_entreprise = db_insert('user_entreprise')
  -> fields(array(
      'id_user_responsable' => $id_user_responsable,
      'id_drupal_user' => $id_extranet_drupal_user,
      'numero_demande' => $numero_demande,
      'charte_signe'   => 1,
      'nom_signe'   => $nom_signe,
      'date_charte_signe' =>  shared_send_to_mssql_date(null, 'datetime'),
  ))
  ->execute();
  db_set_active();

  return $id_user_entreprise;
}

/**
 * creation_compte_entreprise_db_save_user_habilitations
 *
 * Sauvegarde les habilitations d'un utilisateur
 * BDD: DB_EXTRANET
 * Table : lien drupal user habilitation
 *
 * @param array $form_state
 * @param int $id_drupal_user
 */
function creation_compte_entreprise_db_save_user_habilitations($form_state, $id_drupal_user) {
  db_set_active(@DB_EXTRANET);

  $user_habilitations = $form_state['storage']['creation_compte_entreprise_formulaire_form_data']['utilisateur']['utilisateur_fonctions']; // Save user roles and permissions

  $sql_delete = db_delete('lien_drupal_user_habilitation')  // Supprime toutes les habilitations de l'utilisateur associ� � l'id
    ->condition('id_drupal_user' , $id_drupal_user, '=')
    ->execute();

  foreach ($user_habilitations as $key => $value) {   // Sauvegarde les habilitations  // Vaudrait mieux faire un db_update : lien_drupal_user_habilitation
    if ($value != '0') {
      $hab_sql = db_insert('lien_drupal_user_habilitation')
      ->fields(array(
          'id_drupal_user'     => $id_drupal_user,
          'id_habilitation'    => $key,
      ))
      ->execute();
    }
  }
  db_set_active();
}

/**
 * creation_compte_entreprise_db_save_lien_entreprise
 *
 * Fonction qui permet de lier l'user_entreprise � un ou plusieurs �tablissements
 *
 * @param array $form_state
 * @param int $id_user_entreprise
 * @param int $id_entreprises
 */
function creation_compte_entreprise_db_save_lien_entreprise($form_state, $id_user_entreprise, $id_entreprises) {
  db_set_active(@DB_EXTRANET);
  foreach ($id_entreprises as $id_entreprise) {
    db_insert('lien_user_entreprise_ref_esclave_entreprise')
      ->fields(array(
          'id_user_entreprise'     => $id_user_entreprise,
          'id_ref_esclave_entreprise'    => $id_entreprise,
          'est_valide' => 0,
          'est_actif' => 1,
      ))
      ->execute();
  }
  db_set_active();
}