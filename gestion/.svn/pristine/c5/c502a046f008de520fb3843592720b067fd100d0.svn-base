<?php

function dgf_demande_export() {
  require_once 'suivi_demande_db.inc';
  $post_data = isset($_SESSION['suivi_demande_filter']) ? $_SESSION['suivi_demande_filter'] : null;
  $datas = suivi_demande_get_demandes($post_data, true);
  $file = @TEMP_FOLDER . '\\'.uniqid().'.csv';
  

  $header = array(
      'statut',
      'multi-établissement',
      'date creation',
      'numéro demande',
      'date envoi myopca',
      'nature demande',
      'duree totale heure',
      'date début',
      'date fin',
      'nb participant',
      'intitulé formation',
      'raison sociale',
      'paiement direct',
      'cout pédagogique',
      'étape demande',
      'prestataire ou organisme',
      'salarié',
    );
  create_csv_file_to_export($datas, $file, $header);
}
function objectToArray($d) {
    if (is_object($d)) {
        // Gets the properties of the given object
        // with get_object_vars function
        $d = get_object_vars($d);
    }

    if (is_array($d)) {
        /*
        * Return array converted to object
        * Using __FUNCTION__ (Magic constant)
        * for recursive call
        */
        return array_map(__FUNCTION__, $d);
    }
    else {
        // Return array
        return $d;
    }
}
/**
 * Ecrit le fichier CSV du suivi des demandes
 * 
 * @param array $datas
 * @param string $file
 * @param array $header
 */
function create_csv_file_to_export($datas, $path, $header) {
  // On définit le délimiteur de champs ";" pour Excel
  $delimiter = ';';

  // On créer le header pour le téléchargement du fichier
 header("Content-Type: txt/csv");
 header("Content-Disposition: attachment; filename=suivi_demande_export_".date("Ymd").".csv");

  // On ouvre le fichier
  $file = fopen($path, 'w');
  // On définit l'encodage correspondant à UTF-8
  fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));
  // On écrit l'entête du tableau CSV
  fputcsv($file, $header, $delimiter);
  // On insère les lignes avec traitement si besoin
  foreach ($datas as $row) {
    $row = objectToArray($row);
      $row = array_values($row);
    unset($row['id']);
   fputcsv($file, array_values($row), $delimiter);
  }
  fclose($file);
  readfile($path);
  exit;
}