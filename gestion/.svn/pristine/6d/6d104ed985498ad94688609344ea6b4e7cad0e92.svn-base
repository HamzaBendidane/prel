<?php

/**
 * Submit for the contract step
 *
 * @param type $form
 * @param type $form_state
 */
function dgf_formation_form_submit($form, &$form_state) {
  
  
  /*Demande autre que contrat pro*/
  if((isset($_SESSION['demande'])) && ($_SESSION['demande'] != '1')){
    $multi = isset($_SESSION['demande']['multi_etab']);
    $etablissements =$_SESSION['demande']['multi_etab'];

    $id_dgf = formation_db_insert_dgf($form_state,$multi);
    $id_temp_dgf_form_demande = formation_db_insert_temp_dgf_form_demande($id_dgf, $_SESSION['demande']['nature_demande'],
          $_SESSION['demande']['nature_formation']);
    $id_lien_dgf_ref_esclave_entreprise = formation_db_insert_lien_dgf_ref_esclave_entreprise($form_state, $id_dgf,$etablissements);
      unset($_SESSION['demande']);
    
    $id_form_formation = formation_db_insert_temp_dgf_form_autre_dispo($form_state,$id_dgf);
    //     TO DO save repartition
  /*Fin demande autre que contrat pro*/
  }
  else {
    if ($form_state['values']['id_dgf_formation'] === '') {
      $id_form_formation = formation_db_insert_temp_dgf_form_formation($form_state);
      // save répartition
      formation_db_delete_insert_temp_dgf_form_formation_repartition($form_state, $id_form_formation, true);
    } else {
      formation_db_update_temp_dgf_form_formation($form_state);
      // save répartition
      $id_form_formation = $form_state['values']['id_dgf_formation'];
    
      formation_db_delete_insert_temp_dgf_form_formation_repartition($form_state, $id_form_formation, false);
    }
  }

  // On redirige l'utilisateur vers le bon écran
  if ($form_state['triggering_element']['#id'] == 'edit-modal-save'){
    drupal_goto('/dashboard');
  } else if ($form_state['triggering_element']['#id'] == 'edit-next') {
    // si formation interne, on remplit les infos dans la table OF et on redirigé à l'étape tuteur
    if ($form_state['values']['internal_training']) {
      drupal_goto('/dgf/demande/contrat-pro/tuteur/'.$form_state['values']['id_dgf']);
    } else {
      drupal_goto('/dgf/demande/organisme-formation/'.$form_state['values']['id_dgf']);
    }
  }
}