<?php
 
/**
 * Implementation of hook_block_info().
 */
function ecofolio_fullsidebar_block_info(){
  $blocks['ecofolio_fullsidebar_full'] = array('info'=>'Ecofolio full sidebar');
  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function ecofolio_fullsidebar_block_view($delta=''){
  global $base_url, $user, $node;
  $block = array();
  switch($delta){
    case 'ecofolio_fullsidebar_full':
      $block = ecofolio_fullsidebar_bloc_full();
      break;

  }
  return $block;
}




function ecofolio_fullsidebar_bloc_full() {
  if(arg(0)=='node' && is_numeric(arg(1))) $node_tmp = node_load(arg(1));
  if(isset($node_tmp) && ($node_tmp->type=="home_univers" || $node_tmp->type=="page" || $node_tmp->type=="webform" || $node_tmp->type=="actu")) {
    $contenu = '';
    //contact
    if($node_tmp->type=="webform" && isset($node_tmp->field_bloc_contact[LANGUAGE_NONE])) {
      $contenu .= <<< END
    <div class="bloc_contact">
      {$node_tmp->field_bloc_contact[LANGUAGE_NONE][0]['value']}
    </div>
END;
    }
    if($node_tmp->type=="home_univers" || $node_tmp->type=="page") { //menu nos dossiers
      $liste = '';
      if(isset($node_tmp->field_homeunivers_ds['und'])) {
        foreach($node_tmp->field_homeunivers_ds['und'] as $ds) {
          $node_ds = node_load($ds['nid']);
          $liste .= '<li><a href="'.url('node/'.$node_ds->nid).'">'.$node_ds->title.'</a></li>';
        }
      }
      if(isset($node_tmp->field_basicpage_bds['und'])) {
        foreach($node_tmp->field_basicpage_bds['und'] as $ds) {
          $node_ds = node_load($ds['nid']);
          $liste .= '<li><a href="'.url('node/'.$node_ds->nid).'">'.$node_ds->title.'</a></li>';
        }
      }
      if($liste!='') $contenu .= <<< END
        <div class="nos_dossiers">
          <h3>Nos dossiers</h3>
          <ul>
            {$liste}
          </ul>
        </div>
END;
    }
    
    //btn de découverte
    //bloc_bouton_sidebar
    //print_r($node_tmp);
    if(isset($node_tmp->field_bloc_bouton_sidebar['und'])) {
      foreach($node_tmp->field_bloc_bouton_sidebar['und'] as $bs_dec) {
        $entity = node_load($bs_dec['nid']);
        //$entity = field_collection_field_get_entity($bs_dec);
        $link = $entity->field_bs_link['und'][0]['url'];
        $link_title = $entity->title;
        if(isset($entity->field_bloc_img_image['und'])) $img = '<img src="'.image_style_url("320-310", $entity->field_bloc_img_image['und'][0]['uri']).'" />';
        else $img = '';
        $contenu .= <<< END
          <div class="bloc_decouverte">
            <a href="{$link}">
              {$img}
              <div class="footer_intra">
                <p>{$link_title}<span class="more"></span></p>
              </div>
            </a>
          </div>
END;
      }
    }/*if(isset($node_tmp->field_homeunivers_bs['und'])) {
      foreach($node_tmp->field_homeunivers_bs['und'] as $bs_dec) {
        $entity = field_collection_field_get_entity($bs_dec);
        $link = $entity->field_bs_link['und'][0]['url'];
        $link_title = $entity->field_bs_title['und'][0]['value'];
        if(isset($entity->field_bs_image['und'])) $img = '<img src="'.image_style_url("320-310", $entity->field_bs_image['und'][0]['uri']).'" />';
        else $img = '';
        $contenu .= <<< END
          <div class="bloc_decouverte">
            <a href="{$link}">
              {$img}
              <div class="footer_intra">
                <p>{$link_title}<span class="more"></span></p>
              </div>
            </a>
          </div>
END;
      }
    }if(isset($node_tmp->field_webform_bs['und'])) {
      foreach($node_tmp->field_webform_bs['und'] as $bs_dec) {
        $entity = field_collection_field_get_entity($bs_dec);
        $link = $entity->field_webform_bs_link['und'][0]['url'];
        $link_title = $entity->field_webform_bs_title['und'][0]['value'];
        if(isset($entity->field_bs_image['und'])) $img = '<img src="'.image_style_url("320-310", $entity->field_bs_image['und'][0]['uri']).'" />';
        else $img = '';
        $contenu .= <<< END
          <div class="bloc_decouverte">
            <a href="{$link}">
              {$img}
              <div class="footer_intra">
                <p>{$link_title}<span class="more"></span></p>
              </div>
            </a>
          </div>
END;
      }
    }if(isset($node_tmp->field_actu_bs['und'])) {
      foreach($node_tmp->field_actu_bs['und'] as $bs_dec) {
        $entity = field_collection_field_get_entity($bs_dec);
        $link = $entity->field_actu_bs_link['und'][0]['url'];
        $link_title = $entity->field_actu_bs_title['und'][0]['value'];
        if(isset($entity->field_bs_image['und'])) $img = '<img src="'.image_style_url("320-310", $entity->field_bs_image['und'][0]['uri']).'" />';
        else $img = '';
        $contenu .= <<< END
          <div class="bloc_decouverte">
            <a href="{$link}">
              {$img}
              <div class="footer_intra">
                <p>{$link_title}<span class="more"></span></p>
              </div>
            </a>
          </div>
END;
      }
    }*/

    //bloc intra
    if(isset($node_tmp->field_bloc_intra['und'])) {
      $n_intra = node_load($node_tmp->field_bloc_intra['und'][0]['nid']);
      if(isset($n_intra->field_bloc_intra_link['und'])) $link = url('node/'.$n_intra->field_bloc_intra_link['und'][0]['nid']);
      elseif(isset($n_intra->field_bs_link['und'])) $link = $n_intra->field_bs_link['und'][0]['url'];
      else $link = '';
      if(isset($n_intra->field_bloc_intra_link['und']))  $link_title = $n_intra->field_bloc_intra_link_text['und'][0]['value'];
      else $link_title = 'Découvrir';
      $img = image_style_url("320-310", $n_intra->field_bloc_intra_image['und'][0]['uri']);
      $contenu .= <<< END
        <div class="bloc_intra">
          <a href="{$link}">
            <div class="top">
              <h3>{$n_intra->field_bloc_intra_label['und'][0]['value']}</h3>
              <p>{$n_intra->field_bloc_intra_teaser['und'][0]['value']}</p>
            </div>
            <img src="{$img}" />
            <div class="encart">
              <div class="decouvrir"><span>{$link_title}</span></div>
            </div>
          </a>
        </div>
END;
    }
      //print_r($node_tmp);
  } else  $contenu = '';
  return array("subject"=>"", "content"=>$contenu);
}


?>