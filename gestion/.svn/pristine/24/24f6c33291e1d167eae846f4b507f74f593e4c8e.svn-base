<?php

/**
 * creation_compte_entreprise_form
 *
 * @param unknown $form
 * @param unknown $form_state
 * @return unknown
 */
function creation_compte_entreprise_form($form, &$form_state) {
  if (isset($form_state['storage']['display_page'])) {
    if ($form_state['storage']['display_page'] == 'charte') {
      return creation_compte_entreprise_charte_form($form, $form_state);
    } else if ($form_state['storage']['display_page'] == 'confirmation') {
      return creation_compte_entreprise_confirmation_form($form, $form_state);
    } else {
      return creation_compte_entreprise_formulaire_form($form, $form_state);
    }
  } else {
    return creation_compte_entreprise_formulaire_form($form, $form_state);
  }
}

/**
 * creation_compte_entreprise_formulaire_form
 *
 * @param unknown $form
 * @param unknown $form_state
 */
function creation_compte_entreprise_formulaire_form($form, &$form_state) {
  $form['page'] = array(
      '#type' => 'hidden',
      '#value' => 'formulaire',
  );

  // Si on a déjà remplis le formulaire, et qu'on clique sur back
  if (isset($form_state['storage']['creation_compte_entreprise_formulaire_form_data'])) {
    $form_state['input'] = $form_state['storage']['creation_compte_entreprise_formulaire_form_data'];
    foreach ($form_state['input']['utilisateur']['utilisateur_fonctions'] as $key => $value) {
      if ($value === 0) {
        unset($form_state['input']['utilisateur']['utilisateur_fonctions'][$key]);
      }
    }
//     if ($form_state['input']['company']['demande_multi_siret'] === 0) {
//       unset($form_state['input']['company']['demande_multi_siret']);
//     }
  }

  _creation_compte_entreprise_form_entreprise($form, $form_state);

  _creation_compte_entreprise_form_responsable($form, $form_state);

  _creation_compte_entreprise_form_utilisateur($form, $form_state);

  $form['back'] = array(
      '#type' => 'button',
      '#value' => t('Précédent'),
      '#limit_validation_errors' => array()
  );

  $form['next'] = array(
      '#type' => 'submit',
      '#value' => t('Suivant'),
  );

  return $form;
}

/**
 * _creation_compte_entreprise_form_entreprise
 *
 * @param unknown $form
 * @param unknown $form_state
 */
function _creation_compte_entreprise_form_entreprise(&$form, &$form_state) {
  $form['#tree'] = TRUE;

  $form['company']['nb_siret'] = array(
      '#type' => 'hidden',
      '#default_value' => 1,
  );

  $nb_siret = isset($form_state['input']['company']['nb_siret']) ? $form_state['input']['company']['nb_siret'] : 1;

  for ($i = 0; $i < $nb_siret; $i++) {

    // Numéro siret
    $form['company']['siret'][$i] = array(
        '#type'  => 'textfield',
        '#title' => t('N° Siret'),
        '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
          <span class="spinner">&nbsp;</span>',
        '#attributes' => array(
            'placeholder' => t('Min. 3 premiers caractères'),
            'class' => array('autocomplete-siret')),
    );

    // Raison sociale obligatoire
    $form['company']['raison_sociale'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Raison sociale'),
    );

//     $form['company']['code_naf'][$i] = array(
//         '#type'     => 'textfield',
//         '#title'    => t('Code NAF'),
//         '#attributes' => array(
//             'class' => array(
//               'coller-serrer-1', 'field-code'),
//               'data-table' => 'nafs',
//               'data-code' => 'code',
//               'data-libelle' => 'libelle',
//         )
//     );
    
    $form['company']['id_nace'][$i] = array(
        '#type'     => 'hidden',
        '#title'    => t(''),
    );
    
    $form['company']['code_nace'][$i] = array(
        '#type'     => 'select',
        '#title'    => t('Code nace'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        )
    );
    
    $form['company']['libelle_nace'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t(''),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        )
    );

//   $form['company']['code_nace'][$i] = array(
//       '#type'     => 'textfield',
//       '#title'    => t('Code NACE'),
// //       '#options'  => shared_db_get_code_naces(),
//   );
//     $form['company']['libelle_naf'][$i] = array(
//         '#type'     => 'textfield',
//         '#title'    => t(''),
//         '#attributes' => array(
//             'class' => array('coller-serrer-2', 'field-libelle'),
//               'data-table' => 'nafs',
//               'data-code' => 'code',
//               'data-libelle' => 'libelle',
//         )
//     );

//     $form['company']['id_naf'][$i] = array(
//         '#type' => 'hidden',
//         '#attributes' => array(
//             'class' => array('field-id'),
//         )
//     );

//     $secteurs_activites = shared_get_secteurs_activites();
    $form['company']['code_filiere'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Filière 1'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        )
    );

    $form['company']['libelle_filiere'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Filière 1'),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        )
    );

    $form['company']['id_filiere'][$i] = array(
        '#type'     => 'hidden',
        '#attributes' => array(
            'class' => array('field-id'),
        )
    );

    $form['company']['code_filiere2'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Filière 2'),
        '#attributes' => array(
            'class' => array('coller-serrer-1'),
        )
    );
    
    $form['company']['libelle_filiere2'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Filière 1'),
        '#attributes' => array(
            'class' => array('coller-serrer-2'),
        )
    );
    
    $form['company']['id_filiere2'][$i] = array(
        '#type'     => 'hidden',
        '#attributes' => array(
            'class' => array('field-id'),
        )
    );

    $form['company']['adresse'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Adresse'),
        '#attributes' => array(
            'placeholder' => t('Nº voie'))
    );

    // Adresse obligatoire complément
    $form['company']['complement_adresse'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Complément rue'),
    );

      // Adresse obligatoire complément
      $form['company']['complement_adresse_2'][$i] = array(
          '#type'     => 'textfield',
          '#title'    => t('Complément rue 2'),
      );

    // Code postal obligatoire
    $form['company']['code_postal'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t('Code postal / Ville'),
        '#attributes' => array(
            'placeholder' => t('Code Postal'),
            'class' => array('coller-serrer-1')
        ),
    );

    // Ville obligatoire
    $form['company']['ville'][$i] = array(
        '#type'     => 'textfield',
        '#title'    => t(''),
        '#attributes' => array(
            'placeholder' => t('Ville'),
            'class' => array('coller-serrer-2')
        ),
    );
  }

  $form['company']['demande_multi_siret'] = array(
      '#type' =>'checkbox',
      '#title' => t('Voulez-vous faire une demande d’ouverture de compte pour plusieurs établissements ?  '),
  );


  // Button ajoutez un siret
  $form['company']['ajout_siret'] = array(
      '#type'     => 'button',
      '#value'    => t('Ajoutez un siret'),
  );
}

function _creation_compte_entreprise_form_responsable(&$form, &$form_state) {
  $form['responsable']['responsable_titre'] = array(
      '#type' => 'select',
      '#title' => t('Titre'),
      '#options' => shared_db_get_title(true),
  );

  // Code postal obligatoire
  $form['responsable']['responsable_nom'] = array(
      '#type' => 'textfield',
      '#title' => t('Nom'),
      '#element_validate' => array('element_shared_nom_validate'),
  );

  // Téléphone
  $form['responsable']['responsable_prenom'] = array(
      '#type' => 'textfield',
      '#title' => t('Prénom'),
      '#element_validate' => array('element_shared_nom_validate'),
  );

  // Email
  $form['responsable']['responsable_email'] = array(
      '#type' => 'textfield',
      '#title' => t('Courriel'),
  );

  $form['responsable']['responsable_email2'] = array(
      '#type' => 'textfield',
      '#title' => t('Confirmer courriel'),
      '#validate' => array('company_register_check_responsable_email_form_validate'),
  );

  // Fonction
  $form['responsable']['responsable_fonction'] = array(
      '#type' => 'textfield',
      '#title' => t('Fonction'),
  );
}

function _creation_compte_entreprise_form_utilisateur(&$form, &$form_state) {
  // Titre
  $form['utilisateur']['utilisateur_titre'] = array(
      '#type' => 'select',
      '#title' => t('Titre'),
      '#options' => shared_db_get_title(true),
  );
  // Nom utilisateur
  $form['utilisateur']['utilisateur_nom'] = array(
      '#type' => 'textfield',
      '#title' => t('Nom'),
      '#element_validate' => array('element_shared_nom_validate'),
  );
  // Prenom utilisateur
  $form['utilisateur']['utilisateur_prenom'] = array(
      '#type' => 'textfield',
      '#title' => t('Prénom'),
      '#element_validate' => array('element_shared_nom_validate'),
  );
  // Email
  $form['utilisateur']['utilisateur_email'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
  );
  $form['utilisateur']['utilisateur_email2'] = array(
      '#type' => 'textfield',
      '#title' => t('Confirmer courriel'),
  );
  // Fonction
  $form['utilisateur']['utilisateur_fonction'] = array(
      '#type' => 'select',
      '#title' => t('Fonction'),
      '#options' => shared_db_get_fonction(true),
  );
  // Téléphone
  $form['utilisateur']['utilisateur_telephone'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
  );

  // Mot de passe
  $form['utilisateur']['utilisateur_password'] = array(
//       '#title' => t('Mot de passe'),
      '#type' => 'password_confirm',
      '#size' => 25,
  );

  // Fonctionnalités de l'utilisateur
  $habilitations = shared_get_habilitation();

  $form['utilisateur']['utilisateur_fonctions'] = array(
      '#type'    => 'checkboxes',
      '#title'   => t('Fonctionnalités'),
      '#options' => $habilitations,
  );
}

function creation_compte_entreprise_charte_form($form, &$form_state) {
  $form['page'] = array(
      '#type' => 'hidden',
      '#value' => 'charte',
  );

  $form['validate'] = array(
      '#type' => 'checkbox',
      '#title'    => t(@VALIDATION_CHARTE_TEXTE),
  );

  $form['signature'] = array(
      '#type'       => 'textfield',
      '#title'      => t('Je soussigné(e)'),
      '#attributes' => array(
          'placeholder' => array(t('Veuillez entrer votre nom')),
      ),
  );

  $form['valider'] = array(
      '#type' => 'submit',
      '#value' => t('Valider'),
  );
  return $form;
}

/**
 * creation_compte_entreprise_confirmation_form
 *
 */
function creation_compte_entreprise_confirmation_form($form, &$form_state) {
  $form['page'] = array(
      '#type' => 'hidden',
      '#value' => 'confirmation',
  );

  // Si on a déjà remplis le formulaire, et qu'on clique sur back
  if (isset($form_state['storage']['creation_compte_entreprise_formulaire_form_data'])) {
    $form_state['input'] = $form_state['storage']['creation_compte_entreprise_formulaire_form_data'];
    foreach ($form_state['input']['utilisateur']['utilisateur_fonctions'] as $key => $value) {
      if ($value === 0) {
        unset($form_state['input']['utilisateur']['utilisateur_fonctions'][$key]);
      }
    }
//     if ($form_state['input']['company']['demande_multi_siret'] === 0) {
//       unset($form_state['input']['company']['demande_multi_siret']);
//     }
  }


  _creation_compte_entreprise_form_entreprise($form, $form_state);
  _creation_compte_entreprise_form_responsable($form, $form_state);
  _creation_compte_entreprise_form_utilisateur($form, $form_state);


  $form['back'] = array(
      '#type' => 'submit',
      '#value' => t('Modifier'),
      '#limit_validation_errors' => array()
  );

  $form['imprimer'] = array(
      '#type' => 'button',
      '#value' => t('Imprimer'),
      '#limit_validation_errors' => array()
  );

  $form['confirmer'] = array(
      '#type' => 'submit',
      '#value' => t('Confirmer'),
  );

  return $form;
}