<?php

// TODO : mettre les libellés dans un fichier séparé

function _dgf_contrat_pro_stagiaire_require_once_files() {
  require_once 'stagiaire_langs.inc';
  require_once 'stagiaire_submit.inc';
  require_once 'stagiaire_validate.inc';
  require_once 'stagiaire_db.inc';
}

/**
 *  Fonctions include des JS & CSS
 *
 */
function _dgf_contrat_pro_stagiaire_include_js_css() {
  drupal_add_js(drupal_get_path('module', 'dgf_contrat_pro' ) . '/inc/stagiaire/js/stagiaire.js' );
  drupal_add_css(drupal_get_path('module', 'dgf_contrat_pro' ) . '/inc/stagiaire/css/stagiaire.css' );
}

/**
 *  Formulaire des types de demande DGF.
 *
 *  @param: $form, &$form_state
 *  @return: $form
 *
 */
function dgf_contrat_pro_stagiaire_form($form, &$form_state) {
  _dgf_contrat_pro_stagiaire_require_once_files();
  _dgf_contrat_pro_stagiaire_include_js_css();

  // on regarde le 4eme argument de l'url
  $temp_dgf_form_salarie = array();
  $stagiaire = array();
  // s'il est rempli, on récupère les informations de la bdd
  if (arg(4) !== null) {

    $id_dgf = shared_security_access_user(4, 'DGF');
    $temp_dgf_form_salarie = salarie_db_get_temp_dgf_form_salarie($id_dgf);
    $stagiaire = salarie_db_get_v_salarie($temp_dgf_form_salarie['id_ref_esclave_salarie']);
  }

  shared_get_referentiel_data(array('ref_diplome', 'ref_derniere_situation','ref_beneficiaire_minimas_sociaux'));
  shared_get_referentiel_data_code('ref_diplome');

  $form['cerfa-step'] = array(
      '#type' => 'hidden',
      '#default_value' => '/'.drupal_get_path('theme', 'opcaim').'/images/cerfa-2.png',
  );

  $form['id_dgf'] = array(
      '#type' => 'hidden',
      '#default_value' => shared_isset_trim(@$id_dgf),
      '#title' => t('Id demande' )
  );
  global $user; // Utilisateur connecté.

  if (has_role_admin() || has_role_adefim()) {
      // Si Admin ou Admin/Super Admin OPCAIM
      $raison_social = '';
      $id_ref_esclave_entreprise = null;
      if ($temp_dgf_form_salarie) {
          $id_ref_esclave_entreprise = trim($temp_dgf_form_salarie['id_ref_esclave_entreprise']);
          $raison_social = $id_ref_esclave_entreprise
            ? shared_get_raison_sociale_siret_entreprise($id_ref_esclave_entreprise) : '';
      }

      $form['fieldset1']['tout_etablissement'] = array(
              '#type' => 'textfield',
              '#title' => t('Etablissement'),
              '#attributes' => array(
                      'placeholder' => t('SIRET ou raison sociale'),
                      'class' => array('autocomplete-siret')),
              '#default_value' => $raison_social,
              '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
                <span class="spinner">&nbsp;</span>',
      );

      $form['fieldset1']['etablishment'] = array(
              '#type' => 'hidden',
              '#default_value' => $id_ref_esclave_entreprise,
      );

  } else {

      // Listes des entreprises
      $entreprises = shared_db_functions_get_ref_esclave_entreprise();

      // Id entreprise de l'utilisateur
      $id_drupal_user = shared_get_drupal_user_id($user->uid);
      $id_user_entreprise = shared_get_user_id_entreprise($id_drupal_user);
      $id_entreprise_from_user = shared_get_id_entreprise_from_user_entreprise($id_user_entreprise);

      if (empty($entreprises)) {
          drupal_set_message('Attention, il n\'y a aucun établissement pour votre compte utilisateur. Vous ne pouvez faire
      une demande.', 'error');
      } else {
          $form['fieldset1']['etablishment'] = array(
                  '#type' => 'select',
                  '#title' => t('Etablissement'),
                  '#options' => $entreprises,
                  '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_esclave_entreprise']) : 0,
          );
      }
  }

  $form['fieldset1']['collective_convention'] = array(
      '#type' => 'hidden',
      '#title' => t(''),
      '#default_value' => isset($temp_dgf_form_salarie) ? shared_isset_trim(@$temp_dgf_form_salarie['id_ref_esclave_convention_collective']) : NULL,
      //      '#options' => contrat_db_get_convention_collective(),
  );

  $form['fieldset1']['collective_convention_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Convention collective'),
      '#attributes' => array(
          'class' => array('coller-serrer-3')
      ),
      '#default_value' => $temp_dgf_form_salarie ? shared_isset_trim(@$temp_dgf_form_salarie['convention_collective']['code']) : NULL,
  );

  $form['fieldset1']['collective_convention_libelle'] = array(
      '#type' => 'textfield',
      '#title' => t(''),
      '#attributes' => array(
          'class' => array('coller-serrer-4')
      ),
      '#default_value' => $temp_dgf_form_salarie ? shared_isset_trim(@$temp_dgf_form_salarie['convention_collective']['libelle']) : NULL,
  );

  $form['id_salarie'] = array(
      '#type' => 'hidden',
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_esclave_salarie']) : null,
      '#title' => t('Id salarie' ));

  $form['fieldset2']['lastname'] = array(
     '#element_validate' => array('element_shared_nom_validate'),
    '#type' => 'textfield',
    '#default_value' => ($stagiaire) ? trim($stagiaire['nom']) : null,
    '#title' => t('Nom' ),
    '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
      <span class="spinner">&nbsp;</span>',
  );

  $form['fieldset2']['firstname'] = array(
      '#element_validate' => array('element_shared_nom_validate'),
      '#type' => 'textfield',
      '#prefix' => '<div class="required">',
      '#default_value' => ($stagiaire) ? trim($stagiaire['prenom']) : null,
      '#suffix' => '</div>',
      '#title' => t('Prénom' ));

  $datepicker_icon = '<span class="glyphicon glyphicon-calendar add-on"></span>';

  $form['fieldset2']['birthday'] = array(
    '#title' => t('Date de naissance'),
    '#type' => 'textfield',
    '#field_suffix' => $datepicker_icon,
      '#element_validate' => array('element_shared_date_validate'),
    '#default_value' => ($stagiaire) ? date_format(date_create($stagiaire['date_de_naissance']), 'd/m/Y')  : null,
    '#attributes' => array('class' => array('datePicker', 'date-lenght'),"autocomplete"=>"off", 'placeholder' => t('jj/mm/aaaa'))
  );

  $form['fieldset2']['age'] = array(
    '#type' => 'textfield',
    '#title' => t('Âge'),
    '#attributes' => array(
        'readonly' => 'readonly',
        'class' => array('min-lenght'),
    ),
  );

  $civilites = shared_db_get_title(false);
  $form['fieldset2']['man_woman'] = array(
      '#type' => 'radios',
      '#title' => t('Civilité'),
      '#default_value' => ($stagiaire) ? trim($stagiaire['id_civilite']) : null,
      '#options' => $civilites
  );

  $form['fieldset2']['handicapped_worker'] = array(
      '#type' => 'radios',
      '#title' => t('Reconnu travailleur handicapé'),
      '#default_value' => ($stagiaire) ? $stagiaire['est_travailleur_handicape'] : null,
      '#options' => array(
          1 => t('Oui' ),
          0 => t('Non'),
      )
  );
  $form['fieldset3']['nom_rue'] = array(
      '#type' => 'textfield',
      '#title' => t('Adresse'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['nom_rue'] : null,
      '#element_validate' => array('element_shared_not_empty_validate'),
  );

  $form['fieldset3']['complement_adresse'] = array(
      '#type' => 'textfield',
      '#title' => t('Complément rue'),
      '#attributes' =>array('placeholder' => t('Complément rue')),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['complement_adresse'] : null,
  );

    $form['fieldset3']['complement_adresse_2'] = array(
        '#type' => 'textfield',
        '#title' => t('Complément rue 2'),
        '#attributes' =>array('placeholder' => t('Complément rue 2')),
        '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['complement_adresse_2'] : null,
    );

  $form['fieldset3']['zip_code'] = array(
      '#type' => 'textfield',
     '#title' => t('Code postal / Ville'),
     '#attributes' => array(
         'placeholder' => t('Code Postal'),
         'class' => array('coller-serrer-1', 'cp-lenght', 'cp-field')
     ),
     '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['code_postal'] : null,
      '#element_validate' => array('element_shared_code_postal'),
  );

  $form['fieldset3']['city'] = array(
      '#type' => 'textfield',
   //   '#title' => t('Ville'),
      '#attributes' => array(
          'placeholder' => t('Ville'),
          'class' => array('coller-serrer-2')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['ville'] : null,
  );

  $form['fieldset3']['phone_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['telephone'] : null,
      '#attributes' =>array(
          'placeholder' => t('Ex: 0142154798'),
          'class' => array('telephone-lenght')
      ),
  );

  $form['fieldset3']['email'] = array(
      '#type' => 'textfield',
      '#title' => t('Courriel'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['email'] : null,
  );

  $form['fieldset4']['highest_level'] = array(
      '#type' => 'hidden',
      '#title' => t(''),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_diplome']) : null,
  );

  $form['fieldset4']['highest_level_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Diplôme le plus élevé'),
      '#attributes' => array(
          'class' => array('coller-serrer-3', 'light-gap-right')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['diplome']['code']) : null,
  );

  $form['fieldset4']['highest_level_label'] = array(
      '#type' => 'textfield',
      '#title' => t(''),
      '#attributes' => array(
          'class' => array('coller-serrer-4')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['diplome']['label']) : null,
      '#field_suffix' => '<a id="highest_level_tooltip" class="glyphicon glyphicon-question-sign" data-toggle="tooltip" data-original-title="le message à definir" style ="float:none;"></a>',
  );


  $form['fieldset4']['social_beneficiary'] = array(
      '#type' => 'hidden',
      '#title' => t(''),
//       '#options' =>  $_SESSION['referentiel_extranet_datas']['ref_beneficiaire_minimas_sociaux'],
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_beneficiaire_minimas_sociaux']) : null,
  );

  $form['fieldset4']['social_beneficiary_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Bénéficiaire des minimas sociaux'),
      '#attributes' => array(
          'class' => array('coller-serrer-3', 'light-gap-right')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['beneficiaire_minimas_sociaux']['code']) : null,
  );

  $form['fieldset4']['social_beneficiary_label'] = array(
      '#type' => 'textfield',
      '#title' => t(''),
      '#attributes' => array(
          'class' => array('coller-serrer-4')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['beneficiaire_minimas_sociaux']['label']) : null,
  );

  $form['fieldset4']['last_status'] = array(
      '#type' => 'hidden',
      '#title' => t(''),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['id_ref_derniere_situation']) : null,
  );

  $form['fieldset4']['last_status_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Dernière situation'),
      '#attributes' => array(
          'class' => array('coller-serrer-3', 'light-gap-right')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['derniere_situation']['code']) : null,
  );

  $form['fieldset4']['last_status_label'] = array(
      '#type' => 'textfield',
      '#title' => t(''),
      '#attributes' => array(
          'class' => array('coller-serrer-4')
      ),
      '#default_value' => ($temp_dgf_form_salarie) ? trim($temp_dgf_form_salarie['derniere_situation']['label']) : null,
  );

  $form['fieldset4']['pole_emploi_number'] = array(
      '#type' => 'textfield',
      '#title' => t("Numéro d'inscrit au pôle emploi"),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['numero_inscrit_pole_emploi'] : null,
  );

  $form['fieldset4']['since_month'] = array(
      '#type' => 'textfield',
      '#title' => t('Depuis combien de mois'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['nombre_mois_inscrit_pole_emploi'] : null,
  );

  $form['fieldset4']['pension_fund'] = array(
      '#type' => 'textfield',
      '#title' => t('Caisse de retraite'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['caisse_retraite'] : null,
  );

  $form['fieldset4']['contingency_fund'] = array(
      '#type' => 'textfield',
      '#title' => t('Caisse de prévoyance'),
      '#default_value' => ($temp_dgf_form_salarie) ? $temp_dgf_form_salarie['caisse_prevoyance'] : null,
  );

  $form['fieldset5']['plus_26_ans'] = array(
      '#type' => 'item',
      '#field_suffix' => '<div class="messageInfo">'.t(@RAPPEL_DEMANDE_CONTRAT_PRO_STAGIAIRE).'</div>',
      '#title' => t(''),
  );


  // Ajout des boutons d'actions
  $validatorsBoutonNext = array(
      'dgf_contrat_pro_stagiaire_standard_form_validate',
      'dgf_contrat_pro_stagiaire_specific_form_validate',
   );
  $submitsBoutonNext = array('dgf_contrat_pro_stagiaire_form_submit');
  dgf_boutons_action_form($form, $validatorsBoutonNext, $submitsBoutonNext);

  // Ajout de la modal quitter
  $validatorsQuit = array('dgf_contrat_pro_stagiaire_form_validate');
  $validatorsSave = array(
      'dgf_contrat_pro_stagiaire_standard_form_validate',
      'dgf_contrat_pro_stagiaire_specific_form_validate',
  );
  $submitsSave = array('dgf_contrat_pro_stagiaire_form_submit');
  dgf_modal_quit_form($form, $validatorsQuit, $validatorsSave, $submitsSave);

  return $form;
}

