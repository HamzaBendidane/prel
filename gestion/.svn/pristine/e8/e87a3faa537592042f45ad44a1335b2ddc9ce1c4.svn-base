<?php

/**
 * administration_utilisateurs_modification_form
 *
 * @param unknown $form
 * @param unknown $form_state
 * @param unknown $etablissements
 * @return multitype:string multitype:multitype:string   Ambigous <The, string, A, Optional>
 */
function administration_utilisateurs_common_form($form, &$form_state) {
  if (arg(0) === 'mon-compte') {
    global $user;
    $id_drupal_user = shared_get_drupal_user_id($user->uid);
  } else {
    $id_drupal_user = arg(3);
  }
  $user_infos = shared_users_verify_get_infos_from_id($id_drupal_user);
  if ($user_infos) {
    $user_infos = $user_infos[0];
  }
  // Titre
  $form['utilisateur']['utilisateur_titre'] = array(
      '#type' => 'select',
      '#title' => t('Titre'),
      '#options' => shared_db_get_title(true),
      '#default_value' => $user_infos ? trim($user_infos->civilite) : '',
      '#required' => TRUE,
  );
  // Nom utilisateur
  $form['utilisateur']['utilisateur_nom'] = array(
      '#element_validate' => array('element_shared_nom_validate'),
      '#type' => 'textfield',
      '#title' => t('Nom'),
      '#default_value' => $user_infos ? trim($user_infos->last_name) : '',
      '#required' => TRUE,
  );
  // Prenom utilisateur
  $form['utilisateur']['utilisateur_prenom'] = array(
      '#element_validate' => array('element_shared_nom_validate'),
      '#type' => 'textfield',
      '#title' => t('Prénom'),
      '#default_value' => $user_infos ? trim($user_infos->first_name) : '',
      '#required' => TRUE,
  );

  // Email
  $form['utilisateur']['utilisateur_email'] = array(
      '#type' => 'textfield',
      '#title' => t('Email'),
      '#default_value' => $user_infos ? trim($user_infos->mail) : '',
      '#required' => TRUE,
  );

  // Fonction
  $form['utilisateur']['utilisateur_fonction'] = array(
      '#type' => 'select',
      '#title' => t('Fonction'),
      '#options' => shared_db_get_fonction(true),
      '#default_value' => $user_infos ? trim($user_infos->fonction) : '',
      '#required' => TRUE,
  );
  // Téléphone
  $form['utilisateur']['utilisateur_telephone'] = array(
      '#type' => 'textfield',
      '#title' => t('Téléphone'),
      '#default_value' => $user_infos ? trim($user_infos->telephone) : '',
      '#required' => TRUE,
      '#attributes' => array('class' => array('telephone-lenght')),
  );

  // Fonctionnalités de l'utilisateur
  $habilitations = shared_get_habilitation();
  if ($user_infos) {
    $user_habilitations = shared_db_get_user_habilitations($user_infos->id);
    $default_value = array_keys($user_habilitations);
  } else {
    $default_value = array();
  }

  $form['utilisateur']['utilisateur_password'] = array(
  //       '#title' => t('Mot de passe'),
      '#type' => 'password_confirm',
      '#size' => 25,
  );

  $form['utilisateur']['utilisateur_habilitations'] = array(
      '#type'    => 'checkboxes',
      '#title' => t(''),
      '#attributes' => array('class' => array('SelectAll')),
      '#options' => $habilitations,
      '#default_value' => $default_value
  );

  // Attacher un nouveau SIRET
  $form['utilisateur']['tout_etablissement'] = array(
      '#type' => 'textfield',
      '#title' => t('Entreprise'),
      '#attributes' => array(
        'placeholder' => t('SIRET ou raison sociale'),
        'class' => array('autocomplete-siret')),
      '#field_suffix' => '<img src='.base_path() . path_to_theme() . '/' . 'images/search.png'.' />
        <span class="spinner">&nbsp;</span>',
  );
  $form['utilisateur']['id_etablissement'] = array(
      '#type' => 'hidden',
  );

  // Afficher les champs raisons du retrait si on est sur "mon compte"
  if (arg(0) === 'mon-compte') {
    $form['utilisateur']['raison_retrait'] = array(
        '#type' => 'radios',
        '#title' => t('Raison : '),
        '#options' => array(
            'Je ne gère plus cet établissement',
            'Je change de fonction',
            'L\'établissement n\'existe plus',
            'Autre : précisez',
        ),
    );
    $form['utilisateur']['raison_retrait_autre'] = array(
        '#type' => 'textfield',
        '#title' => t('Précisez : '),
    );
  }

  $form['bouton']['bloquer'] = array(
      '#type' => 'submit',
      '#value' => t('Bloquer'),
      '#attributes' => array(
          'class' => array('btn btn-danger'),
      ),
  );

  $form['bouton']['modifier'] = array(
      '#type' => 'submit',
      '#value' => t('Modifier'),
      '#attributes' => array(
          'class' => array('btn btn-success'),
      ),
  );
  $url = url('opcaim-admin/utilisateurs/supprimer/'.$id_drupal_user);
  $form['bouton']['refuser'] = array(
      '#type' => 'submit',
      '#value' => t('Refuser'),
      '#attributes' => array(
          'class' => array('btn btn-success'),
          'data-href' => $url
      ),
  );

  $form['bouton']['valider'] = array(
      '#type' => 'submit',
      '#value' => t('Valider'),
      '#attributes' => array(
          'class' => array('btn btn-success'),
      ),
  );

  $form['bouton']['ajouter'] = array(
      '#type' => 'submit',
      '#value' => t('Ajouter'),
      '#attributes' => array(
          'class' => array('btn btn-success'),
      ),
  );
  $form['bouton']['back'] = array(
      '#type' => 'button',
      '#value' => t('Annuler'),
      '#limit_validation_errors' => array(),
      '#attributes' => array('class' => array('cancel')),
  );

  return $form;
}