<?php
require_once 'historique_db.inc';
drupal_add_js(drupal_get_path('module', 'dgf_visualisation_finale' ) . '/inc/historique/js/historique.js' );
drupal_add_css(drupal_get_path('module', 'dgf_visualisation_finale' ) . '/inc/historique/css/historique.css' );


function dgf_visualisation_finale_historique() {

  shared_security_access_user(2,'DGF');
  $relance_histo = array();
  $id_dgf = arg(2);
  
  $historique = historique_get_all_relance($id_dgf);
  $justificatifs = array();
  $destinataires = array();
  
  foreach ($historique as $relance ) {
    $histo_justif= historique_get_all_justificatif($relance['id']);
    $histo_destinataire= historique_get_all_destinataire($relance['id']);
    if($histo_justif) {
      foreach($histo_justif as $justificatif) {
        $justificatifs[$relance['id']][]=$justificatif;
      }
    } else $justificatifs[$relance['id']] = null;
    foreach($histo_destinataire as $destinataire) {
      $destinataires[$destinataire['id_relance']][]=$destinataire;
    }
    
    $relance_histo[$relance['id']]['relance']= $relance;
    $relance_histo[$relance['id']]['justificatif']= $justificatifs[$relance['id']];
    $relance_histo[$relance['id']]['destinataire']= $destinataires[$relance['id']];
  }

  return $relance_histo;

}

