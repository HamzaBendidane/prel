<?php
function ecofolio_mail_alter(&$message) {

   $message['headers']['bcc'] = "demat_web@ecofolio.fr";

}
/**
 * Implementation of hook_block_view().
 */
function ecofolio_header_block_view($delta=''){
  global $base_url, $user, $node;
  $block = array();
  switch($delta){
    case 'ecofolio_header_full':
      $block = ecofolio_header_bloc_full();
      break;

  }
  return $block;
}




function ecofolio_header_bloc_full() {
  $logo = theme_get_setting('logo'); 
  $sitename = variable_get('site_name', "Ecofolio"); 
  $url_base = url("",array("absolute"=>true));
  
  if(drupal_is_front_page()) {
    $view = views_get_view('diaporama_homepage');
    $slider = $view->render('block');
  } else $slider = '';
  
  $view = views_get_view('bloc_espace_declaration');
  $espace_decla = $view->render('block');

  $top_menu = '';
  $top_menu_tree = menu_tree_all_data('menu-top-menu',null,1);
  menu_tree_add_active_path($top_menu_tree);
  foreach($top_menu_tree as $tmt) {
    if(($tmt['link']['hidden']==0) && ($tmt['link']['link_path']!='<front>')) {
      if($tmt['link']['in_active_trail']==1) $top_menu .= '<li class="active"><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a></li>';
      else $top_menu .= '<li><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a></li>';
    }
  }

  $main_menu = '';
  $main_menu_tree = menu_tree_all_data('main-menu',null,1);
  menu_tree_add_active_path($main_menu_tree);
  $nb_total_main_menu = count($main_menu_tree);
  $nb_main_menu = 0;
  $class_last = '';
  //if( $_SERVER["REMOTE_ADDR"] == "80.15.162.48") {
  //  print_r($main_menu_tree);
  //}
  foreach($main_menu_tree as $tmt) {
    if(($tmt['link']['hidden']==0)) {
      $nb_main_menu++;
      if($nb_main_menu == $nb_total_main_menu) $class_last = 'last';
      //print_r($tmt);
      if($tmt['link']['in_active_trail']==1 || (drupal_is_front_page() && $tmt['link']['href']=='<front>')) $main_menu .= '<li class="active '.$class_last.'"><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a></li>';
      else $main_menu .= '<li class="'.$class_last.'"><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a></li>';
    } else $nb_total_main_menu--;
  }
  
  function print_main_menu_mobile_tree($tmt,$level) {
      $return = '';
      if($tmt['link']['in_active_trail']==1 || (drupal_is_front_page() && $tmt['link']['href']=='<front>')) $return .= '<li class="active '.$class_last.'"><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a>';
      else $return .= '<li><a href="'.url($tmt['link']['href'],array("absolute"=>true)).'"><span>'.$tmt['link']['title'].'</span></a>';
      if(count($tmt['below'])>0) {
        if($level==1) $return .= '<div class="submenu">';
          if($level==1) $return .= '<div class="back"></div>';
          if($level==1) $return .= '<ul class="subsubmenu">';
          else $return .= '<ul>';
            foreach($tmt['below'] as $below) if($below['link']['hidden']==0) $return .= print_main_menu_mobile_tree($below,$level+1);
          $return .= '</ul>';
        if($level==1) $return .= '</div>';
      }
      $return .= '</li>';
      return $return;
  }
  $main_menu_mobile = '';
  $main_menu_mobile_tree = menu_tree_all_data('main-menu');
  menu_tree_add_active_path($main_menu_mobile_tree);
  //if( $_SERVER["REMOTE_ADDR"] == "80.15.162.48") {
  //  print_r($main_menu_mobile_tree);
  //}
  foreach($main_menu_mobile_tree as $tmt) {
    if(($tmt['link']['hidden']==0)) {
      //print_r($tmt);
      $main_menu_mobile .= print_main_menu_mobile_tree($tmt,1);
    }
  }
  
  
  $bloc = drupal_get_form('ecofolio_header_search_form');
  $form_search = render($bloc);
  
  $block = block_load("menu_block", 1);
  $render_array = _block_get_renderable_array(_block_render_blocks(array($block)));
  $menu_contextuel = render($render_array);

  $view = views_get_view('social_networks_footer');
  $follow_us = $view->render('block');

  $contenu = <<< END
  <div class="header_full">
    <div class="slider">
      {$slider}
    </div>
    <div class="encart_top">
      <div class="logo"><a href="{$url_base}"><img src="{$logo}" alt="{$sitename}" /></a></div>
      <div class="logo_min"></div>
      <div class="menu_top_right">
        <ul>
          {$top_menu}
        </ul>
      </div>
      <a href="" class="espace_decla">Espace déclarations</a>
    </div>
    <div class="menu_espace_decla">
      <div class="background">
        <div class="inner_menu_espace_decla">
          <span class="picto"></span>
          {$espace_decla}
          <a href="" class="close">close</a>
        </div>
      </div>
    </div>
    <div class="main_menu">
      <ul>
        {$main_menu}
        <li class="search"><span class="search"></span></li>
      </ul>
      <div class="line"></div>
      <div class="search">
        {$form_search}
        <a href="" class="close">close</a>
      </div>
    </div>
    <div class="main_menu_ipad">
      <div class="menu_burger">
        <a href="" class="menu_burger"><span class="ico"></span></a>
        <div class="ico_seach"><span class="ico"></span></div>
        <div class="search">
          <div class="close"></div>
          {$form_search}
        </div>
      </div>
      <div class="top_menu">
        <div class="inner_top_menu">
          <div class="top">
            <a href="" class="back"></a>
            <ul>
              <li class="top"><span class="top"></span></li>
              {$main_menu}
            </ul>
            <div class="bottom">
              <div class="follow_us">
                {$follow_us}
              </div>
            </div>
          </div>
          <div class="menu_contextuel">
            <div class="back"></div>
            {$menu_contextuel}
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="header_mobile">
    <div class="encart_top">
      
      <div class="top_bar">
        <div class="logo"><a href="{$url_base}"><img src="{$logo}" alt="{$sitename}" /></a></div>
        <div class="bt_menu">
          <span class="ico"></span>
        </div>
      </div>

      <div class="menu_top_right">

        <div class="main_menu">
          <div class="top">
             <ul>
              {$main_menu_mobile}
            </ul>
            <a href="" class="back"></a>
          </div>
          <div class="bottom">
            <div class="follow_us">
              {$follow_us}
            </div>
            <div class="seach_btn"><a href="" class="search"></a></div>
            <div class="search">
              {$form_search}
            </div>
          </div>
        </div>

        <div class="menu_contextuel">
          <div class="back"></div>
          {$menu_contextuel}
        </div>

      </div>
    </div>
    <div class="slider">
      {$slider}
    </div>
  </div>
END;
  return array("subject"=>"", "content"=>$contenu);
}

function ecofolio_header_search_form($form, &$form_state, $keys = '') {
  $info = FALSE;
  $keys = trim($keys);

  if (!$keys && !empty($_REQUEST['search'])) {
    $keys = trim($_REQUEST['search']);
  }

  $form['search'] = array(
    '#type' => 'textfield', 
    '#default_value' => $keys, 
    '#size' => 40, 
    '#maxlength' => 255,
    '#attributes' =>array('placeholder' => t('Rechercher par mot-clés'))
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('OK'),
  );

  if (!empty($form_state['results'])) {
    $form['search_results'] = $form_state['results'];
  }

  return $form;
}

function ecofolio_header_search_form_submit($form, &$form_state) {
  $search = $form_state['values']['search'];
  if($search!='') drupal_goto('recherche', array('query'=>array('search'=>$search)));
}

?>