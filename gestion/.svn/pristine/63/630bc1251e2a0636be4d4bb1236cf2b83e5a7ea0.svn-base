<?php
module_load_include('inc', 'node', 'node.pages');
  
function _password_recover_submit($form, &$form_state){
    $form_state['redirect'] = false;
    drupal_set_message(
        t("Votre demande a bien été prise en compte. Vous devez maintenant activer votre nouveau mot de passe via lie lien d'activation que vous allez recevoir par email."
        ), 'resetpassword'
    );
}

function ecofolio_form_alter(&$form, &$form_state, $form_id) {
    $form['search_block_form']['#attributes']['placeholder'] = t('Rechercher');
    $form['#submit'][] = 'ecofolio_form_submit';
    if ('user_pass' == $form_id) {
        $form['#submit'][] = '_password_recover_submit';
    }
	 elseif ($form_id == 'user_login_block') {
		$ajax = array(
			'callback' => 'ecofolio_user_login_block_form_callback',
			'wrapper' => $form['#id'],
			'method' => 'replace',
			'progress' => array('message' => '')
		);
		$form['#prefix'] = '<p class="intro">Pour accéder à ce contenu, veuillez vous identifier ou créer un compte</p>';
		$form['actions']['submit']['#executes_submit_callback'] = TRUE;
		$form['actions']['submit']['#ajax'] = $ajax;
		
	} elseif (strstr($form_id, 'simplenews_block_form')) {
		form_load_include($form_state, 'inc', 'simplenews', 'includes/simplenews.subscription');
		$ajax = array(
			'callback' => 'ecofolio_simplenews_block_form_callback',
			'wrapper' => $form['#id'],
			'method' => 'replace',
			'effect' => 'fade',
			'progress' => array('message' => '')
		);
		$form['submit']['#executes_submit_callback'] = TRUE;
		$form['submit']['#ajax'] = $ajax;
		$form['submit']['#value'] = "OK";
		unset($form['mail']['#title']);
		$form['mail']['#attributes']['placeholder'] = t('Votre email');
	} elseif ($form_id == 'user_pass') {
    $form['title'] = array(
      '#type' => 'item',
      '#markup' => '<div class="user-pass-title">Mot de passe oublié</div>',
      '#weight' => -100,
    );

    $form['message'] = array(
      '#type' => 'item',
      '#markup' => '<div class="user-pass-message">Un lien vous permettant de réinitialiser votre mot de passe vous sera adressé à l\'adresse mail que vous aurez saisie. Si ce mail n\'est pas parvenu dans votre boîte de réception, merci de vérifier dans "courriers indésirables" de votre boîte mail.</div>',
      '#weight' => -50,
    );

    $form['#submit'][]= 'ecofolio_custom_forms_password_submit_handler';

  } elseif (strstr($form_id, 'parution_node_form')) {
    $form['field_fichier_lies']['#access'] = FALSE;
    $form['actions']['preview']['#access'] = FALSE;
    $form['actions']['delete']['#access'] = FALSE;
    
    // Disable tabledrag                                                                                           
    $javascript = &drupal_static('drupal_add_js', array());
    unset($javascript['misc/tabledrag.js']);
    // Prevent it from being enabled later.                                                                                        
    $tabledrag_added = &drupal_static('drupal_add_tabledrag');
    $tabledrag_added = TRUE;
    

    $noms_fichiers_annonces = array();
    $nom_fichier = "";
    foreach ($form['field_fichier_lies']['und'] as $field_nom_fichier) {
      if (isset($field_nom_fichier['field_nom_fichier']['und'])) {
        $nom_fichier = $field_nom_fichier['field_nom_fichier']['und'][0]['#entity']->field_nom_fichier['und'][0]['value'];
        if ($nom_fichier) {
          $noms_fichiers_annonces[] = '<li>' . $nom_fichier . '</li>';
        }
      }
    }
    
    $form['actions']['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Enregistrer'),
      '#executes_submit_callback' => TRUE,
      '#ajax' => array(
        'wrapper' => $form['#id'],
        'method' => 'replace',
        'callback' => 'ecofolio_parution_node_form_callback',
        'progress' => array('message' => '', 'type' => 'throbber'),
      ),
      '#prefix' => '<div id="edit-mandatory-fields" class="form-item form-type-item">
 <div class="mandatory-fields">Les champs marqués d\'un * sont obligatoires</div>
</div>'
    );
    
    $form['#prefix'] = '<div id="parution-wrapper">';
    $form['#suffix'] = '</div>';
    
    $form['title']['#prefix'] = '<ul class="parutions-nom-fichier">' . implode("", array_unique($noms_fichiers_annonces)) . '</ul>';
    $form['title']['#title'] = t('Nom du support');
    $form['field_parution_date']['und']['add_more']['#value'] = t('Ajouter une date');
  }
}

function ecofolio_parution_node_form_callback($form, $form_state){
  $errors = form_get_errors();
  if (!$errors || (count($errors) == 1 && array_key_exists('changed', $errors))) {
    $node = node_form_submit_build_node($form, $form_state);
    node_save($node);
  }
  
  $form_state['rebuild'] = TRUE;
  return $form;
}

function ecofolio_custom_forms_password_submit_handler($form, &$form_state) {
  unset($_REQUEST['destination']);
  unset($form['#redirect']);

  $form_state['redirect']  = '';
}

function ecofolio_form_submit($form, &$form_state) {
  if (isset($_GET['destination'])) {
    unset($_GET['destination']);
  }

  $form_id = $form['form_id']['#value'];
  $form_state['redirect'] = array(
    'recherche',
            array(
                'query' => array(
                    'search' => trim($form_state['values'][$form_id]),
                ),
            ),
    );
}

function ecofolio_user_login_block_form_callback($form, $form_state) {
	$errors = form_get_errors();
	if( $errors ) {
		return $form;
	} else {
		ctools_include('ajax');
		ctools_add_js('ajax-responder');
		$commands[]  = ctools_ajax_command_reload();
		print ajax_render($commands);
		drupal_exit();
	}
}

function ecofolio_simplenews_block_form_callback($form, $form_state) {
	return $form;
}

/*******************************
CUSTOM USER LOGIN BLOCK
********************************/

function ecofolio_form_user_login_block_alter(&$form) {
	// For debug
	//drupal_set_message('<pre>' . check_plain(var_export($form, TRUE)) . '</pre>');

	// Remove the links provided by Drupal.
	unset($form['links']);

	// Set a weight for form actions so other elements can be placed beneath them.
	$form['actions']['#weight'] = 5;
	
	unset($form['name']['#title']);
	$form['name']['#size'] = 18;
	$form['name']['#attributes'] = array('placeholder' => t('Identifiant / Courriel'));
	
	unset($form['pass']['#title']);
	$form['pass']['#size'] = 12;
	$form['pass']['#attributes'] = array('placeholder' => t('Mot de passe'));
	
	$form['request_password'] = array(
		'#markup' => l(
			t('Mot de passe oublié'), 
			'user/password', 
			array(
				'attributes' => array(
					'title' => t('Réinitialisez votre mot de passe par courriel.'),
					'class' => array('form-item-reset')
				)
			)
		)
	);
	
	$form['actions']['submit']['#value'] = t('ENVOYER');

	if (variable_get('user_register', USER_REGISTER_VISITORS_ADMINISTRATIVE_APPROVAL)) {
    if (arg(0) == 'node' && is_numeric(arg(1))) {
      $node = node_load(arg(1));
      if ($node->type == 'document') {
        $form['actions']['signup'] = array(
          '#markup' => l(
            t('Se créer un compte'),
            'user-editeur/register',
            array(
              'attributes' => array(
                'id' => 'create-new-account',
                'title' => t('Créer un compte'),
                'class' => array('button create-new-account')
              )
            )
          ),
          '#weight' => 10
        );
      }
    } else if (arg(0) == 'espace-editeur') {
      $form['actions']['signup'] = array(
        '#markup' => l(
          t('Se créer un compte'),
          'user-editeur/register',
          array(
            'attributes' => array(
              'id' => 'create-new-account',
              'title' => t('Créer un compte'),
              'class' => array('button create-new-account')
            )
          )
        ),
        '#weight' => 10
      );
    } else {
      $form['actions']['signup'] = array(
        '#markup' => l(
          t('Se créer un compte'),
          'user/register',
          array(
            'attributes' => array(
              'id' => 'create-new-account',
              'title' => t('Créer un compte'),
              'class' => array('button create-new-account')
            )
          )
        ),
        '#weight' => 10
      );
    }
	}
}


function ecofolio_preprocess_user_login_block(&$vars) {
  $vars['name'] = render($vars['form']['name']);
  $vars['pass'] = render($vars['form']['pass']);
  $vars['request_password'] = render($vars['form']['request_password']);
  $vars['submit'] = render($vars['form']['actions']['submit']);
  $vars['rendered'] = drupal_render_children($vars['form']);
}

// FONCTIONS LIEES AU FORM REGISTER
function ecofolio_form_user_register_form_alter(&$form, &$form_state, $form_id) {
	// Ajout de la fonction de validation
	$form['#validate'][] ='ecofolio_user_register_form_validate';
	
	// Modifcation des titres
	$form['account']['mail']['#title'] = t('Mail');
	$form['account']['name']['#title'] = t('Mail'); // Pour les messages d'erreurs
	$form['account']['name']['#required'] = FALSE;
		
	// Retrait des descriptions
	$form['account']['mail']['#description'] = t('');
	$form['account']['pass']['#description'] = t('');
		
	// Champs cachés
	$form['account']['name']['#type'] = 'hidden';
	$form['simplenews']['#type'] = 'hidden';
	
	// Tri des champs
	$form['account']['mail']['#weight'] = -9;
	$form['account']['pass']['#weight'] = -7;
	$form['field_roles']['#weight'] = -14;

	$form['field_first_name']['#weight'] = -11;
	$form['field_last_name']['#weight'] = -12;
	$form['field_civility']['#weight'] = -13;
	
	// Ajout du champs confirmation pour l'email
	$form['account']['confirmation_mail'] = array(
    '#type' => 'textfield',
    '#title' => t('Confirmation mail'),
    '#maxlength' => EMAIL_MAX_LENGTH,
    '#description' => t(''),
    '#required' => TRUE,
    '#default_value' => '',
	  '#weight' => -8,
	);
    
	// Ajout de la checkbox acceptation
	$form['checkbox_newsletter'] = array(
    '#type' => 'checkbox', 
    '#title' => "Inscription à la newsletter", 
    '#required' => FALSE,
	  '#weight' => 90,
	);

	// Ajout de la checkbox acceptation
	$form['checkbox_acceptation'] = array(
    '#type' => 'checkbox', 
    '#title' => "Acceptation des <a href='/conditions-generales-dutilisation' target='_blank'>conditions générales d'utilisation</a>", 
    '#required' => TRUE,
	  '#weight' => 100,
	);

	$form['actions']['submit']['#value'] = t('ENVOYER');

  if (arg(0) == 'user-editeur') {
    $form['profile_espace_editeur']['#weight'] = -50;
    $form['field_last_name']['#weight'] = -12;
    $form['field_first_name']['#weight'] = -11;
    $form['field_telephone']['#weight'] = -10;
    $form['field_roles']['und']['#required'] = FALSE;
    $form['field_roles']['und']['#type'] = 'hidden';

    unset($form['field_roles']);
    unset($form['field_entreprise_name']);
    unset($form['field_street']);
    unset($form['field_fonction']);
    unset($form['field_structure']);
    unset($form['field_structure_name']);
    unset($form['field_academy']);
    unset($form['field_cycle']);
    unset($form['field_mission']);
    unset($form['field_projet']);
    unset($form['field_tools']);
    unset($form['field_city']);
    unset($form['field_specify']);
    unset($form['field_specify2']);
    unset($form['field_postal_code']);
    unset($form['checkbox_newsletter']);

    $form['captcha']['#weight'] = 110;
    $form['actions']['#weight'] = 120;
  }
  unset($form['profile_main']);
}


// Validation du formulaires des users
function ecofolio_user_register_form_validate(&$form, &$form_state) {
	if ($form_state['values']['confirmation_mail'] != $form_state['values']['mail']) {
    form_set_error('confirmation_mail', t('Veuillez confirmer à nouveau votre adresse électronique.'));
  }
  // Check that that both email and confirmation email are the same
	
	if(isset($form_state['values']['field_roles']['und']['0']['value'])) {
		$role = $form_state['values']['field_roles']['und']['0']['value'];
		$news = $form_state['values']['checkbox_newsletter'];

		foreach($form_state['complete form']['simplenews']['newsletters']['#options'] as $value) {
			 $tb_cor[$value] = array_search($value, $form_state['complete form']['simplenews']['newsletters']['#options']);
			// Par défaut, on charge tous les newsletters
			 $form_state['values']['newsletters'][$tb_cor[$value]] = $tb_cor[$value];
		}

		// Newsletter
		$form_state['values']['newsletters'][$tb_cor['Adhérents']] = 0;
		if($role == 'Conseil d\'administration') {
			
			$form_state['values']['newsletters'][$tb_cor['Entreprises']] = 0;
			$form_state['values']['newsletters'][$tb_cor['Collectivités']] = 0;
			// if($news == 0) 
				// $form_state['values']['newsletters'][$tb_cor['Adhérents']] = 0;
		}

			
		if($role == 'Adhérent') {
			$form_state['values']['newsletters'][$tb_cor['Collectivités']] = 0;
			if($news == 0) {
				$form_state['values']['newsletters'][$tb_cor['Entreprises']] = 0;
				// $form_state['values']['newsletters'][$tb_cor['Adhérents']] = 0;
			}
		}

		if($role == 'Collectivité') {
			$form_state['values']['newsletters'][$tb_cor['Entreprises']] = 0;
			if($news == 0) {
				$form_state['values']['newsletters'][$tb_cor['Collectivités']] = 0;
				// $form_state['values']['newsletters'][$tb_cor['Adhérents']] = 0;
			}
		}
			
		if($role == 'Repreneur' or $role == 'Jeunesse') {
			$form_state['values']['newsletters'][$tb_cor['Entreprises']] = 0;
			$form_state['values']['newsletters'][$tb_cor['Collectivités']] = 0;
			// $form_state['values']['newsletters'][$tb_cor['Adhérents']] = 0;
		}
		// Fin de newsletter
	}
}
// FIN DES FONCTIONS LIEES AU FORM REGISTER

// MODFICATION DU FORM USER_PROFILE_FORM
// retrait de la partie contact
function ecofolio_form_user_profile_form_alter(&$form,$form_state,$form_id) {
  $query = drupal_get_query_parameters();
  if (in_array('pass-reset-token', array_keys($query))) {
    if ($form['account']['current_pass']['#access'] == FALSE) {
      $pass_message = 'Veuillez modifier votre mot de passe';
    } else {
      $pass_message = 'Votre mot de passe a bien été réinitialisé';
    }
    $form['password_message'] = array(
      '#type' => 'item',
      '#markup' => '<div class="pass-reset-message">' . $pass_message . '</div>',
      '#weight' => -1000,
    );
  }

  // retrait de contact
  unset($form['contact']);
  // Désactivation de roles
  $form['field_roles']['#disabled'] = true;

  // Recherche inscription à une newsletter 
  $inscript = FALSE;
  $mail = $form['account']['mail']['#default_value'];
  $liste_newsletters = simplenews_category_list();
  foreach($liste_newsletters as $key => $val) {
  print_r(simplenews_user_is_subscribed($mail, $key));
	if(simplenews_user_is_subscribed($mail, $key)) {
		$inscript = TRUE;
		break;
	}
  }
  $role = $form['field_roles']['und']['#default_value'][0];
  if(($role == 'Entreprise') or ($role == 'Collectivité')) {
	  // Ajout d'une fonction de validation
	  $form['#submit'][] ='ecofolio_user_profile_form_submit';
	  // Ajout de la checkbox acceptation
	  $form['checkbox_newsletter'] = array(
		'#type' => 'checkbox', 
		'#title' => "Abonnement à la newsletter", 
		'#required' => FALSE,
		'#weight' => 90,
		'#default_value' => $inscript,
		);
	}
}

function ecofolio_user_profile_form_submit(&$form, &$form_state) {
	// Gestion de la newsletter
	$mail = $form_state['values']['mail'];
	$liste_newsletters = simplenews_category_list();

	$user_role = $form_state['values']['field_roles']['und'][0]['value'];	
	if($form_state['values']['checkbox_newsletter'] == 1) {
		// inscription
		foreach($liste_newsletters as $key => $val) {
			if($val == 'Entreprises' and $user_role == 'Entreprise') {
				$action = simplenews_subscribe_user($mail, $key, FALSE);
			}
			if($val == 'Collectivités' and $user_role == 'Collectivité') {
				$action = simplenews_subscribe_user($mail, $key, FALSE);
			}
		}
	} else {
		// désinscription
		foreach($liste_newsletters as $key => $val) {
			 $action = simplenews_unsubscribe_user($mail, $key, FALSE);
		}
	}
}


// FIN MODFICATION DU FORM USER_PROFILE_FORM
